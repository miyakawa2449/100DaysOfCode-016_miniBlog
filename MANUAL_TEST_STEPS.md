# 2段階認証 手動テストガイド

## 前提条件
- アプリケーションが起動していること（http://localhost:5000）
- Google Authenticatorアプリがインストール済み

## 📋 テスト手順

### ステップ1: 管理者ログイン
1. ブラウザで `http://localhost:5000/login/` にアクセス
2. 以下の情報でログイン：
   - **メールアドレス**: `admin@example.com`
   - **パスワード**: `AdminPass123!`
3. ログイン成功後、ホームページまたは管理画面にリダイレクト

### ステップ2: 管理画面アクセス
1. `http://localhost:5000/admin/` にアクセス
2. ダッシュボードが表示されることを確認
3. 左サイドバーの「セキュリティ設定」セクションを確認
4. 「⚠️ 2段階認証を設定」リンクをクリック

### ステップ3: 2段階認証設定
1. TOTP設定ページが表示される
2. QRコードと手動入力用シークレットキーが表示されることを確認
3. **シークレットキー**: `HNAKAP6S2L7XZ7RVY5E73OZLUFKFOUMB`

### ステップ4: Google Authenticator設定
1. スマートフォンでGoogle Authenticatorアプリを開く
2. 「+」ボタンをタップ
3. 「QRコードをスキャン」を選択
4. ブラウザに表示されたQRコードをスキャン
   - または「セットアップキーを入力」で手動入力
   - アカウント名: `admin@example.com`
   - キー: `HNAKAP6S2L7XZ7RVY5E73OZLUFKFOUMB`
5. Google Authenticatorに「MiniBlog (admin@example.com)」が追加される

### ステップ5: 2段階認証有効化
1. Google Authenticatorアプリで6桁のコードを確認
2. ブラウザの「認証コード」フィールドにそのコードを入力
3. 「2段階認証を有効化」ボタンをクリック
4. 成功メッセージとともに管理画面にリダイレクト
5. サイドバーが「✅ 2段階認証を無効化」に変わることを確認

### ステップ6: 2段階認証ログインテスト
1. 管理画面の「ログアウト」をクリック
2. 再度ログインページにアクセス
3. 同じ認証情報でログイン：
   - メールアドレス: `admin@example.com`
   - パスワード: `AdminPass123!`
4. **2段階認証ページ**にリダイレクトされることを確認
5. Google Authenticatorで新しい6桁コードを確認
6. そのコードを入力して「認証」ボタンをクリック
7. 管理画面に正常にログインできることを確認

### ステップ7: パスワードリセット機能テスト
1. ログアウト
2. ログインページの「パスワードを忘れた場合」をクリック
3. `admin@example.com` を入力してリセット要求を送信
4. **開発環境用**: コンソールログまたはflask_app.logでリセットURLを確認
   ```
   パスワードリセットURL (開発環境): http://localhost:5000/password_reset/[トークン]/
   ```
5. そのURLにアクセスしてパスワード変更画面を確認

### ステップ8: 2段階認証無効化テスト
1. 管理画面にログイン
2. 「✅ 2段階認証を無効化」をクリック
3. 現在のパスワードを入力して無効化
4. サイドバーが「⚠️ 2段階認証を設定」に戻ることを確認
5. ログアウト→ログインで2段階認証が要求されないことを確認

## 🔍 確認ポイント

### セキュリティ機能
- [ ] CSRF保護が全フォームで有効
- [ ] セッション管理が適切に動作
- [ ] 認証保護が管理機能に適用
- [ ] セキュリティヘッダーが設定済み

### 2段階認証機能
- [ ] QRコード生成が正常動作
- [ ] Google Authenticator連携成功
- [ ] TOTP認証フローが完全動作
- [ ] 認証コード検証が適切
- [ ] 有効/無効切り替えが動作

### パスワードリセット
- [ ] リセット要求が送信される
- [ ] トークンが生成される（ログ確認）
- [ ] リセットページが表示される
- [ ] パスワード強度チェックが動作

## 🚨 トラブルシューティング

### アプリケーションが起動しない
```bash
# プロセス確認
ps aux | grep python

# ログ確認
tail -f flask_app.log

# 手動起動
python app.py
```

### QRコードが表示されない
- ブラウザでJavaScriptが有効か確認
- ページを再読み込み
- 開発者ツールでコンソールエラーを確認

### 認証コードが無効
- Google Authenticatorの時刻同期を確認
- コードは30秒で変更されるため、最新のものを使用
- 手動入力時のタイプミスを確認

### パスワードリセットメールが届かない
- 開発環境では `flask_app.log` でURLを確認
- 本番環境ではSMTP設定を確認

## 📊 テスト結果記録

| 機能 | 状態 | メモ |
|------|------|------|
| 管理者ログイン | ✅/❌ | |
| TOTP設定画面 | ✅/❌ | |
| QRコード生成 | ✅/❌ | |
| Google Authenticator連携 | ✅/❌ | |
| 2段階認証有効化 | ✅/❌ | |
| 2段階認証ログイン | ✅/❌ | |
| パスワードリセット | ✅/❌ | |
| 2段階認証無効化 | ✅/❌ | |

## 🎯 次のステップ
- 本番環境でのSMTP設定
- ブロック型エディタの実装
- APIエンドポイントの追加
- パフォーマンス最適化
{% extends "admin/layout.html" %}

{% block title %}WordPress インポート{% endblock %}
{% block page_title %}WordPress インポート{% endblock %}

{% block breadcrumb %}
{{ super() }}
<li>WordPress インポート</li>
{% endblock %}

{% block content %}
<div class="import-container">
    
    <!-- 説明セクション -->
    <div class="info-box">
        <h5><i class="fas fa-info-circle"></i> WordPress インポートについて</h5>
        <p class="mb-2">WordPressのエクスポートXMLファイルから、記事とカテゴリを一括インポートできます。</p>
        <ul class="mb-0">
            <li>WordPress管理画面の「ツール」→「エクスポート」で取得したXMLファイルが必要です</li>
            <li>公開済みの記事のみがインポートされます</li>
            <li>重複したスラッグの記事・カテゴリは自動的にスキップされます</li>
            <li>アイキャッチ画像は自動的にダウンロードされます（選択時）</li>
        </ul>
    </div>

    <!-- インポート結果 -->
    {% if import_results %}
        {% if import_results.errors %}
            <div class="import-error">
                {% if import_results.is_dry_run %}
                    <h5><i class="fas fa-exclamation-triangle"></i> インポートテスト結果（エラーあり・実際のインポートは実行されていません）</h5>
                    <p class="mb-3 text-warning">
                        <i class="fas fa-info-circle"></i> 
                        これはテスト実行の結果です。エラーを修正後、「テスト実行（実際にはインポートしない）」のチェックを外して本実行してください。
                    </p>
                {% else %}
                    <h5><i class="fas fa-exclamation-triangle"></i> インポート結果（エラーあり）</h5>
                {% endif %}
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-number">{{ import_results.categories_imported }}</div>
                        <div class="stats-label">{% if import_results.is_dry_run %}カテゴリ（検出）{% else %}カテゴリ{% endif %}</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number">{{ import_results.posts_imported }}</div>
                        <div class="stats-label">{% if import_results.is_dry_run %}記事（検出）{% else %}記事{% endif %}</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number">{{ import_results.images_downloaded }}</div>
                        <div class="stats-label">{% if import_results.is_dry_run %}画像（検出）{% else %}画像{% endif %}</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number text-warning">{{ import_results.errors|length }}</div>
                        <div class="stats-label">エラー</div>
                    </div>
                </div>
                
                {% if import_results.errors %}
                    <h6><i class="fas fa-bug"></i> エラー詳細</h6>
                    <div class="error-list">
                        {% for error in import_results.errors[:10] %}
                            <div class="error-item">{{ error }}</div>
                        {% endfor %}
                        {% if import_results.errors|length > 10 %}
                            <div class="error-item"><strong>... 他 {{ import_results.errors|length - 10 }} 件のエラー</strong></div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% else %}
            <div class="import-results">
                {% if import_results.is_dry_run %}
                    <h5><i class="fas fa-search"></i> インポートテスト完了（実際のインポートは実行されていません）</h5>
                    <p class="mb-3 text-info">
                        <i class="fas fa-info-circle"></i> 
                        これはテスト実行の結果です。実際にデータベースに保存するには「テスト実行（実際にはインポートしない）」のチェックを外してください。
                    </p>
                {% else %}
                    <h5><i class="fas fa-check-circle"></i> インポート完了</h5>
                {% endif %}
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-number">{{ import_results.categories_imported }}</div>
                        <div class="stats-label">{% if import_results.is_dry_run %}カテゴリ（検出）{% else %}カテゴリ{% endif %}</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number">{{ import_results.posts_imported }}</div>
                        <div class="stats-label">{% if import_results.is_dry_run %}記事（検出）{% else %}記事{% endif %}</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number">{{ import_results.images_downloaded }}</div>
                        <div class="stats-label">{% if import_results.is_dry_run %}画像（検出）{% else %}画像{% endif %}</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number text-muted">{{ import_results.skipped|length }}</div>
                        <div class="stats-label">スキップ</div>
                    </div>
                </div>
                
                {% if import_results.skipped %}
                    <details class="mt-3">
                        <summary><strong>スキップされた項目 ({{ import_results.skipped|length }}件)</strong></summary>
                        <div class="error-list mt-2">
                            {% for skipped in import_results.skipped[:10] %}
                                <div class="error-item">{{ skipped }}</div>
                            {% endfor %}
                            {% if import_results.skipped|length > 10 %}
                                <div class="error-item"><strong>... 他 {{ import_results.skipped|length - 10 }} 件</strong></div>
                            {% endif %}
                        </div>
                    </details>
                {% endif %}
            </div>
        {% endif %}
    {% endif %}

    <!-- インポートフォーム -->
    <form method="POST" enctype="multipart/form-data" id="importForm">
        {{ form.hidden_tag() }}
        
        <!-- ファイル選択 -->
        <div class="mb-4">
            <label class="form-label fw-bold">{{ form.xml_file.label.text }}</label>
            <div class="file-upload-area" id="fileUploadArea">
                <div class="upload-icon">
                    <i class="fas fa-file-upload"></i>
                </div>
                <h6>XMLファイルをドラッグ&ドロップ または クリックして選択</h6>
                <p class="text-muted mb-0">WordPress エクスポートファイル (.xml)</p>
                {{ form.xml_file(class="form-control d-none", id="fileInput") }}
            </div>
            <div id="selectedFileName" class="mt-2 text-success" style="display: none;"></div>
            {% if form.xml_file.errors %}
                {% for error in form.xml_file.errors %}
                    <div class="text-danger small mt-1">{{ error }}</div>
                {% endfor %}
            {% endif %}
        </div>

        <!-- 著者選択 -->
        <div class="mb-4">
            <label class="form-label fw-bold">{{ form.author_id.label.text }}</label>
            {{ form.author_id(class="form-select") }}
            <div class="form-text">インポートした記事の著者として設定されます</div>
            {% if form.author_id.errors %}
                {% for error in form.author_id.errors %}
                    <div class="text-danger small mt-1">{{ error }}</div>
                {% endfor %}
            {% endif %}
        </div>

        <!-- インポートオプション -->
        <div class="import-options">
            <h6><i class="fas fa-cog"></i> インポートオプション</h6>
            
            <div class="checkbox-group">
                <div class="checkbox-item">
                    {{ form.import_categories(class="form-check-input") }}
                    <label for="{{ form.import_categories.id }}" class="form-check-label">
                        {{ form.import_categories.label.text }}
                    </label>
                </div>
                
                <div class="checkbox-item">
                    {{ form.import_images(class="form-check-input") }}
                    <label for="{{ form.import_images.id }}" class="form-check-label">
                        {{ form.import_images.label.text }}
                    </label>
                </div>
                
                <div class="checkbox-item">
                    {{ form.skip_duplicates(class="form-check-input") }}
                    <label for="{{ form.skip_duplicates.id }}" class="form-check-label">
                        {{ form.skip_duplicates.label.text }}
                    </label>
                </div>
                
                <div class="checkbox-item">
                    {{ form.dry_run(class="form-check-input") }}
                    <label for="{{ form.dry_run.id }}" class="form-check-label">
                        {{ form.dry_run.label.text }}
                    </label>
                </div>
            </div>
        </div>

        <!-- 警告メッセージ -->
        <div class="warning-box">
            <h6><i class="fas fa-exclamation-triangle"></i> 注意事項</h6>
            <ul class="mb-0">
                <li>大量のデータをインポートする場合は、まず「テスト実行」で内容を確認してください</li>
                <li>インポート中はブラウザを閉じないでください</li>
                <li>データベースのバックアップを事前に取っておくことをお勧めします</li>
                <li>重複データは自動的にスキップされ、既存データは変更されません</li>
            </ul>
        </div>

        <!-- 実行ボタン -->
        <div class="d-grid gap-2">
            {{ form.submit(class="btn btn-primary btn-lg", id="submitBtn") }}
        </div>
    </form>

    <!-- 進行状況インジケーター -->
    <div id="progressIndicator" class="text-center mt-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">処理中...</span>
        </div>
        <div class="mt-2">
            <strong>インポート処理中...</strong><br>
            <small class="text-muted">しばらくお待ちください</small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('WordPress import page loaded');
    
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');
    const selectedFileName = document.getElementById('selectedFileName');
    const submitBtn = document.getElementById('submitBtn');
    const progressIndicator = document.getElementById('progressIndicator');
    const form = document.getElementById('importForm');
    
    console.log('Elements found:', {
        fileUploadArea: !!fileUploadArea,
        fileInput: !!fileInput,
        selectedFileName: !!selectedFileName,
        submitBtn: !!submitBtn,
        form: !!form
    });

    // ファイルドロップエリアのクリックイベント
    if (fileUploadArea && fileInput) {
        fileUploadArea.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('File upload area clicked');
            
            // ファイル入力要素がクリックされた場合は何もしない
            if (e.target === fileInput || fileInput.contains(e.target)) {
                return;
            }
            
            fileInput.click();
        });
    }

    // ファイル入力要素のクリック伝播を阻止
    if (fileInput) {
        fileInput.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }

    // ファイル選択時の処理
    if (fileInput && selectedFileName) {
        fileInput.addEventListener('change', function() {
            console.log('File input changed', this.files);
            if (this.files && this.files[0]) {
                const file = this.files[0];
                console.log('Selected file:', file.name, file.size);
                selectedFileName.innerHTML = `<i class="fas fa-file-alt"></i> 選択されたファイル: <strong>${file.name}</strong> (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                selectedFileName.style.display = 'block';
                if (fileUploadArea) {
                    fileUploadArea.classList.add('file-selected');
                }
            }
        });
    }

    // ドラッグ&ドロップの処理
    if (fileUploadArea) {
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Drag over');
            this.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragenter', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Drag enter');
            this.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Drag leave');
            // ドロップエリアから完全に出た場合のみクラスを削除
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('dragover');
            }
        });

        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('File dropped');
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            console.log('Dropped files:', files);
            if (files.length > 0) {
                const file = files[0];
                console.log('Processing file:', file.name, file.type);
                if (file.name.toLowerCase().endsWith('.xml')) {
                    // ファイル入力に設定
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    fileInput.files = dt.files;
                    
                    if (selectedFileName) {
                        selectedFileName.innerHTML = `<i class="fas fa-file-alt"></i> 選択されたファイル: <strong>${file.name}</strong> (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                        selectedFileName.style.display = 'block';
                    }
                    this.classList.add('file-selected');
                    
                    // change イベントを手動で発火
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                } else {
                    alert('XMLファイルを選択してください。');
                }
            }
        });
    }

    // フォーム送信時の処理
    form.addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 処理中...';
        progressIndicator.style.display = 'block';
        
        // スクロールして進行状況を表示
        progressIndicator.scrollIntoView({ behavior: 'smooth' });
    });

    // テスト実行チェックボックスの処理
    const dryRunCheckbox = document.getElementById('dry_run');
    const submitButton = document.getElementById('submit');
    
    dryRunCheckbox.addEventListener('change', function() {
        if (this.checked) {
            submitButton.textContent = 'テスト実行';
            submitButton.className = 'btn btn-warning btn-lg';
        } else {
            submitButton.textContent = 'インポート開始';
            submitButton.className = 'btn btn-primary btn-lg';
        }
    });
});
</script>

<style>
.file-upload-area.file-selected {
    border-color: #28a745;
    background-color: #f8fff9;
}

.file-upload-area.file-selected .upload-icon {
    color: #28a745;
}
</style>
{% endblock %}
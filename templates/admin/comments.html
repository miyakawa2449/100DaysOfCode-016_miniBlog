{% extends "admin/layout.html" %}

{% block title %}ã‚³ãƒ¡ãƒ³ãƒˆç®¡ç†{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆç®¡ç†</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                ğŸ”„ æ›´æ–°
            </button>
        </div>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">ç·ã‚³ãƒ¡ãƒ³ãƒˆæ•°</h5>
                        <h2 class="mb-0">{{ total_comments }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-comments fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">æ‰¿èªæ¸ˆã¿</h5>
                        <h2 class="mb-0">{{ approved_comments }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-warning">
            <div class="card-body text-dark">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">æ‰¿èªå¾…ã¡</h5>
                        <h2 class="mb-0">{{ pending_comments }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">ä»Šæœˆã®ã‚³ãƒ¡ãƒ³ãƒˆ</h5>
                        <h2 class="mb-0">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="btn-group" role="group">
            <a href="{{ url_for('admin.comments', status='all') }}" 
               class="btn btn-{{ 'primary' if status_filter == 'all' else 'outline-primary' }}">
                ã™ã¹ã¦ ({{ total_comments }})
            </a>
            <a href="{{ url_for('admin.comments', status='approved') }}" 
               class="btn btn-{{ 'success' if status_filter == 'approved' else 'outline-success' }}">
                æ‰¿èªæ¸ˆã¿ ({{ approved_comments }})
            </a>
            <a href="{{ url_for('admin.comments', status='pending') }}" 
               class="btn btn-{{ 'warning' if status_filter == 'pending' else 'outline-warning' }}">
                æ‰¿èªå¾…ã¡ ({{ pending_comments }})
            </a>
        </div>
    </div>
    <div class="col-md-6">
        <form method="POST" action="{{ url_for('admin.bulk_comment_action') }}" id="bulkForm">
            {{ csrf_token() }}
            <div class="input-group">
                <select name="action" class="form-select" required>
                    <option value="">ä¸€æ‹¬æ“ä½œã‚’é¸æŠ</option>
                    <option value="approve">æ‰¿èª</option>
                    <option value="unapprove">æ‰¿èªå–ã‚Šæ¶ˆã—</option>
                    <option value="delete">å‰Šé™¤</option>
                </select>
                <button type="submit" class="btn btn-outline-secondary" onclick="return confirmBulkAction()">
                    å®Ÿè¡Œ
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
<div class="table-responsive">
    <table class="table table-hover">
        <thead class="table-dark">
            <tr>
                <th scope="col">
                    <input type="checkbox" id="selectAll" onchange="toggleAllCheckboxes()">
                </th>
                <th scope="col">æŠ•ç¨¿è€…</th>
                <th scope="col">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹</th>
                <th scope="col">ğŸ“° è¨˜äº‹</th>
                <th scope="col">ğŸ“… æŠ•ç¨¿æ—¥æ™‚</th>
                <th scope="col">ğŸ“Š çŠ¶æ…‹</th>
                <th scope="col">ğŸ”§ æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for comment in comments_list.items %}
            <tr class="{{ 'table-light' if not comment.is_approved else '' }}">
                <td>
                    <input type="checkbox" name="comment_ids" value="{{ comment.id }}" form="bulkForm">
                </td>
                <td>
                    <div>
                        <strong>{{ comment.author_name }}</strong><br>
                        <small class="text-muted">{{ comment.author_email }}</small>
                        {% if comment.author_website %}
                            <br><a href="{{ comment.author_website }}" target="_blank" class="small">
                                <i class="fas fa-external-link-alt"></i> ã‚µã‚¤ãƒˆ
                            </a>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <div style="max-width: 300px;">
                        {{ comment.content[:150] }}{% if comment.content|length > 150 %}...{% endif %}
                    </div>
                    {% if comment.parent %}
                        <small class="text-info">
                            <i class="fas fa-reply"></i> {{ comment.parent.author_name }} ã¸ã®è¿”ä¿¡
                        </small>
                    {% endif %}
                </td>
                <td>
                    {% if comment.article %}
                        <a href="{{ url_for('article_detail', slug=comment.article.slug) }}" 
                           target="_blank" class="text-decoration-none">
                            {{ comment.article.title[:50] }}{% if comment.article.title|length > 50 %}...{% endif %}
                        </a>
                    {% else %}
                        <span class="text-muted">è¨˜äº‹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ</span>
                    {% endif %}
                </td>
                <td>
                    <div>
                        {{ comment.created_at.strftime('%Y-%m-%d') }}<br>
                        <small class="text-muted">{{ comment.created_at.strftime('%H:%M') }}</small>
                    </div>
                </td>
                <td>
                    {% if comment.is_approved %}
                        <span class="badge bg-success">âœ… æ‰¿èªæ¸ˆã¿</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">â³ æ‰¿èªå¾…ã¡</span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        {% if comment.is_approved %}
                            <form method="POST" action="{{ url_for('admin.unapprove_comment', comment_id=comment.id) }}" class="d-inline">
                                {{ csrf_token() }}
                                <button type="submit" class="btn btn-outline-warning" title="æ‰¿èªå–ã‚Šæ¶ˆã—">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                        {% else %}
                            <form method="POST" action="{{ url_for('admin.approve_comment', comment_id=comment.id) }}" class="d-inline">
                                {{ csrf_token() }}
                                <button type="submit" class="btn btn-outline-success" title="æ‰¿èª">
                                    <i class="fas fa-check"></i>
                                </button>
                            </form>
                        {% endif %}
                        <button type="button" class="btn btn-outline-info" onclick="viewComment({{ comment.id }})" title="è©³ç´°è¡¨ç¤º">
                            <i class="fas fa-eye"></i>
                        </button>
                        <form method="POST" action="{{ url_for('admin.delete_comment', comment_id=comment.id) }}" class="d-inline">
                            {{ csrf_token() }}
                            <button type="submit" class="btn btn-outline-danger" 
                                    onclick="return confirm('ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\\nâ€»è¿”ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆã‚‚åŒæ™‚ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')" 
                                    title="å‰Šé™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center py-4">
                    <div>
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <p class="text-muted">ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
{% if comments_list.pages > 1 %}
<nav aria-label="ã‚³ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³">
    <ul class="pagination justify-content-center">
        {% if comments_list.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin.comments', page=comments_list.prev_num, status=status_filter) }}">å‰ã¸</a>
            </li>
        {% endif %}
        
        {% for page in comments_list.iter_pages() %}
            {% if page %}
                {% if page != comments_list.page %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin.comments', page=page, status=status_filter) }}">{{ page }}</a>
                    </li>
                {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page }}</span>
                    </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">â€¦</span>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if comments_list.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin.comments', page=comments_list.next_num, status=status_filter) }}">æ¬¡ã¸</a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- ã‚³ãƒ¡ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆè©³ç´°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="commentModalBody">
                <!-- ã‚³ãƒ¡ãƒ³ãƒˆè©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
function toggleAllCheckboxes() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('input[name="comment_ids"]');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function confirmBulkAction() {
    const checkedBoxes = document.querySelectorAll('input[name="comment_ids"]:checked');
    const action = document.querySelector('select[name="action"]').value;
    
    if (checkedBoxes.length === 0) {
        alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return false;
    }
    
    if (!action) {
        alert('æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return false;
    }
    
    let actionText = '';
    switch(action) {
        case 'approve': actionText = 'æ‰¿èª'; break;
        case 'unapprove': actionText = 'æ‰¿èªå–ã‚Šæ¶ˆã—'; break;
        case 'delete': actionText = 'å‰Šé™¤'; break;
    }
    
    return confirm(`${checkedBoxes.length}ä»¶ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’${actionText}ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
}

function viewComment(commentId) {
    // ã‚³ãƒ¡ãƒ³ãƒˆè©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ï¼ˆæœªå®Ÿè£…ï¼‰
    alert('ã‚³ãƒ¡ãƒ³ãƒˆè©³ç´°è¡¨ç¤ºæ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚ID: ' + commentId);
}
</script>
{% endblock %}
{% extends "admin/layout.html" %}

{% block title %}コメント管理{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">💬 コメント管理</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                🔄 更新
            </button>
        </div>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- 統計カード -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">総コメント数</h5>
                        <h2 class="mb-0">{{ total_comments }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-comments fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">承認済み</h5>
                        <h2 class="mb-0">{{ approved_comments }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-warning">
            <div class="card-body text-dark">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">承認待ち</h5>
                        <h2 class="mb-0">{{ pending_comments }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">今月のコメント</h5>
                        <h2 class="mb-0">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- フィルター -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="btn-group" role="group">
            <a href="{{ url_for('admin.comments', status='all') }}" 
               class="btn btn-{{ 'primary' if status_filter == 'all' else 'outline-primary' }}">
                すべて ({{ total_comments }})
            </a>
            <a href="{{ url_for('admin.comments', status='approved') }}" 
               class="btn btn-{{ 'success' if status_filter == 'approved' else 'outline-success' }}">
                承認済み ({{ approved_comments }})
            </a>
            <a href="{{ url_for('admin.comments', status='pending') }}" 
               class="btn btn-{{ 'warning' if status_filter == 'pending' else 'outline-warning' }}">
                承認待ち ({{ pending_comments }})
            </a>
        </div>
    </div>
    <div class="col-md-6">
        <form method="POST" action="{{ url_for('admin.bulk_comment_action') }}" id="bulkForm">
            {{ csrf_token() }}
            <div class="input-group">
                <select name="action" class="form-select" required>
                    <option value="">一括操作を選択</option>
                    <option value="approve">承認</option>
                    <option value="unapprove">承認取り消し</option>
                    <option value="delete">削除</option>
                </select>
                <button type="submit" class="btn btn-outline-secondary" onclick="return confirmBulkAction()">
                    実行
                </button>
            </div>
        </form>
    </div>
</div>

<!-- コメント一覧 -->
<div class="table-responsive">
    <table class="table table-hover">
        <thead class="table-dark">
            <tr>
                <th scope="col">
                    <input type="checkbox" id="selectAll" onchange="toggleAllCheckboxes()">
                </th>
                <th scope="col">投稿者</th>
                <th scope="col">💬 コメント内容</th>
                <th scope="col">📰 記事</th>
                <th scope="col">📅 投稿日時</th>
                <th scope="col">📊 状態</th>
                <th scope="col">🔧 操作</th>
            </tr>
        </thead>
        <tbody>
            {% for comment in comments_list.items %}
            <tr class="{{ 'table-light' if not comment.is_approved else '' }}">
                <td>
                    <input type="checkbox" name="comment_ids" value="{{ comment.id }}" form="bulkForm">
                </td>
                <td>
                    <div>
                        <strong>{{ comment.author_name }}</strong><br>
                        <small class="text-muted">{{ comment.author_email }}</small>
                        {% if comment.author_website %}
                            <br><a href="{{ comment.author_website }}" target="_blank" class="small">
                                <i class="fas fa-external-link-alt"></i> サイト
                            </a>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <div style="max-width: 300px;">
                        {{ comment.content[:150] }}{% if comment.content|length > 150 %}...{% endif %}
                    </div>
                    {% if comment.parent %}
                        <small class="text-info">
                            <i class="fas fa-reply"></i> {{ comment.parent.author_name }} への返信
                        </small>
                    {% endif %}
                </td>
                <td>
                    {% if comment.article %}
                        <a href="{{ url_for('article_detail', slug=comment.article.slug) }}" 
                           target="_blank" class="text-decoration-none">
                            {{ comment.article.title[:50] }}{% if comment.article.title|length > 50 %}...{% endif %}
                        </a>
                    {% else %}
                        <span class="text-muted">記事が削除されました</span>
                    {% endif %}
                </td>
                <td>
                    <div>
                        {{ comment.created_at.strftime('%Y-%m-%d') }}<br>
                        <small class="text-muted">{{ comment.created_at.strftime('%H:%M') }}</small>
                    </div>
                </td>
                <td>
                    {% if comment.is_approved %}
                        <span class="badge bg-success">✅ 承認済み</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">⏳ 承認待ち</span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        {% if comment.is_approved %}
                            <form method="POST" action="{{ url_for('admin.unapprove_comment', comment_id=comment.id) }}" class="d-inline">
                                {{ csrf_token() }}
                                <button type="submit" class="btn btn-outline-warning" title="承認取り消し">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                        {% else %}
                            <form method="POST" action="{{ url_for('admin.approve_comment', comment_id=comment.id) }}" class="d-inline">
                                {{ csrf_token() }}
                                <button type="submit" class="btn btn-outline-success" title="承認">
                                    <i class="fas fa-check"></i>
                                </button>
                            </form>
                        {% endif %}
                        <button type="button" class="btn btn-outline-info" onclick="viewComment({{ comment.id }})" title="詳細表示">
                            <i class="fas fa-eye"></i>
                        </button>
                        <form method="POST" action="{{ url_for('admin.delete_comment', comment_id=comment.id) }}" class="d-inline">
                            {{ csrf_token() }}
                            <button type="submit" class="btn btn-outline-danger" 
                                    onclick="return confirm('このコメントを削除してもよろしいですか？\\n※返信コメントも同時に削除されます。')" 
                                    title="削除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center py-4">
                    <div>
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <p class="text-muted">コメントが見つかりません</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ページネーション -->
{% if comments_list.pages > 1 %}
<nav aria-label="コメントページネーション">
    <ul class="pagination justify-content-center">
        {% if comments_list.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin.comments', page=comments_list.prev_num, status=status_filter) }}">前へ</a>
            </li>
        {% endif %}
        
        {% for page in comments_list.iter_pages() %}
            {% if page %}
                {% if page != comments_list.page %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin.comments', page=page, status=status_filter) }}">{{ page }}</a>
                    </li>
                {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page }}</span>
                    </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">…</span>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if comments_list.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin.comments', page=comments_list.next_num, status=status_filter) }}">次へ</a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- コメント詳細モーダル -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel">💬 コメント詳細</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="commentModalBody">
                <!-- コメント詳細がここに表示されます -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
function toggleAllCheckboxes() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('input[name="comment_ids"]');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function confirmBulkAction() {
    const checkedBoxes = document.querySelectorAll('input[name="comment_ids"]:checked');
    const action = document.querySelector('select[name="action"]').value;
    
    if (checkedBoxes.length === 0) {
        alert('コメントを選択してください。');
        return false;
    }
    
    if (!action) {
        alert('操作を選択してください。');
        return false;
    }
    
    let actionText = '';
    switch(action) {
        case 'approve': actionText = '承認'; break;
        case 'unapprove': actionText = '承認取り消し'; break;
        case 'delete': actionText = '削除'; break;
    }
    
    return confirm(`${checkedBoxes.length}件のコメントを${actionText}してもよろしいですか？`);
}

function viewComment(commentId) {
    // コメント詳細を表示する機能（未実装）
    alert('コメント詳細表示機能は開発中です。ID: ' + commentId);
}
</script>
{% endblock %}
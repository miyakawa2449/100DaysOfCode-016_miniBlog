{% extends "admin/layout.html" %}

{% block title %}ブロックエディタ - {{ article.title if article else '新規記事' }}{% endblock %}
{% block page_title %}{{ '記事編集' if article else '記事作成' }} (ブロック型エディタ){% endblock %}

{% block breadcrumb %}
{{ super() }}
<li><a href="{{ url_for('admin.articles') }}">記事管理</a></li>
<li>{{ '編集: ' + article.title if article else '新規作成' }}</li>
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.css">
<style>
/* ブロックエディタ専用スタイル */
.block-editor-container {
    min-height: 600px;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 20px;
}

.block-editor-empty {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.block-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 15px;
    padding: 15px;
    position: relative;
    transition: all 0.3s ease;
}

.block-item:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
}

.block-item.sortable-chosen {
    opacity: 0.5;
}

.block-item.sortable-ghost {
    background: #e3f2fd;
    border: 2px dashed #2196f3;
}

.block-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
}

.block-type-label {
    font-size: 12px;
    background: #007bff;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    margin-right: 10px;
}

.block-controls {
    display: flex;
    gap: 5px;
}

.block-handle {
    cursor: move;
    color: #6c757d;
    font-size: 18px;
    margin-right: 10px;
}

.block-content-preview {
    margin: 10px 0;
}

.block-form {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.add-block-section {
    position: sticky;
    top: 20px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.block-type-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

.block-type-btn {
    padding: 15px 10px;
    text-align: center;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    background: white;
    transition: all 0.3s ease;
    text-decoration: none;
    color: #495057;
}

.block-type-btn:hover {
    border-color: #007bff;
    background: #f8f9fa;
    color: #007bff;
    text-decoration: none;
}

.block-type-icon {
    font-size: 24px;
    margin-bottom: 8px;
    display: block;
}

/* プレビュー用スタイル */
.preview-button {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

/* 画像プレビュー */
.image-preview-container {
    max-width: 300px;
    margin: 10px 0;
}

.image-preview {
    max-width: 100%;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .block-editor-container {
        padding: 15px;
    }
    
    .block-type-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .preview-button {
        position: relative;
        margin-bottom: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<form method="POST" enctype="multipart/form-data" id="blockEditorForm" action="{{ url_for('admin.create_article_block_editor') if not article else url_for('admin.edit_article_block_editor', article_id=article.id) }}">
    {{ form.hidden_tag() }}
    {{ form.is_published() }}
    {{ form.allow_comments() }}
    
    <div class="row">
        <!-- メインエディタエリア -->
        <div class="col-lg-8">
            <!-- 記事基本情報とブロックエディタ -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fa fa-edit me-2"></i>記事作成・編集</h5>
                    <div class="d-flex gap-2">
                        {% if article %}
                        <a href="{{ url_for('admin.edit_article', article_id=article.id) }}" 
                           class="btn btn-outline-secondary btn-sm">
                            <i class="fa fa-edit me-1"></i>従来型エディタに切り替え
                        </a>
                        {% endif %}
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="previewArticle()">
                            <i class="fa fa-eye me-1"></i>プレビュー
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 記事基本情報 -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="form-floating mb-3">
                                {{ form.title(class="form-control", placeholder="記事タイトル", required=true) }}
                                <label for="title">記事タイトル *</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                {{ form.slug(class="form-control", placeholder="article-slug") }}
                                <label for="slug">スラッグ</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-floating mb-4">
                        {{ form.summary(class="form-control", placeholder="記事の概要を入力してください", rows="3") }}
                        <label for="summary">記事概要</label>
                    </div>
                    
                    <!-- ブロックエディタ -->
                    <div class="border-top pt-4">
                        <h6 class="mb-3"><i class="fa fa-th-list me-2"></i>記事コンテンツ (ブロック)</h6>
                        <div id="blockEditor" class="block-editor-container">
                            {% if blocks %}
                                {% for block in blocks %}
                                {% if block.block_type.type_name != 'featured_image' %}
                                <div class="block-item" data-block-id="{{ block.id }}" data-block-type="{{ block.block_type.type_name }}">
                                    <div class="block-header">
                                        <div>
                                            <i class="fa fa-bars block-handle"></i>
                                            <span class="block-type-label">{{ block.block_type.type_label }}</span>
                                            <span class="block-title-text">{{ block.title or '無題' }}</span>
                                        </div>
                                        <div class="block-controls">
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editBlock({{ block.id }})">
                                                <i class="fa fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteBlock({{ block.id }})">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="block-content-preview">
                                        {% include 'blocks/' + block.block_type.type_name + '_block.html' %}
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            {% else %}
                                <div class="block-editor-empty">
                                    <i class="fa fa-plus-circle fa-3x mb-3"></i>
                                    <h5>最初のブロックを追加してください</h5>
                                    <p class="text-muted">右側のパネルからブロックタイプを選択して記事を作成しましょう</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- サイドバー -->
        <div class="col-lg-4">
            <!-- ブロック追加パネル -->
            <div class="add-block-section">
                <h6><i class="fa fa-plus me-2"></i>ブロックを追加</h6>
                <div class="block-type-grid">
                    <a href="#" class="block-type-btn" onclick="addBlock('text')">
                        <i class="fa fa-font block-type-icon"></i>
                        <small>テキスト</small>
                    </a>
                    <a href="#" class="block-type-btn" onclick="addBlock('image')">
                        <i class="fa fa-image block-type-icon"></i>
                        <small>画像</small>
                    </a>
                    <a href="#" class="block-type-btn" onclick="addBlock('sns_embed')">
                        <i class="fa fa-share-alt block-type-icon"></i>
                        <small>SNS埋込</small>
                    </a>
                    <a href="#" class="block-type-btn" onclick="addBlock('external_article')">
                        <i class="fa fa-external-link block-type-icon"></i>
                        <small>外部記事</small>
                    </a>
                </div>
            </div>
            
            <!-- 公開設定 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fa fa-globe me-2"></i>公開設定</h6>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="is_published_check" name="is_published_check" {{ 'checked' if (form.is_published.data == 'true') or (article and article.is_published) else '' }}>
                        <label class="form-check-label" for="is_published_check">
                            記事を公開する
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="allow_comments_check" name="allow_comments_check" {{ 'checked' if (form.allow_comments.data == 'true') or (article and article.allow_comments) else '' }}>
                        <label class="form-check-label" for="allow_comments_check">
                            コメントを許可する
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label for="category_id" class="form-label">カテゴリ</label>
                        {{ form.category_id(class="form-select") }}
                    </div>
                </div>
            </div>
            
            <!-- SEO設定 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fa fa-search me-2"></i>SEO設定</h6>
                </div>
                <div class="card-body">
                    <!-- アイキャッチ画像（カテゴリー形式） -->
                    <div class="mb-3">
                        <label class="form-label"><i class="fa fa-image me-2"></i>アイキャッチ画像</label>
                        
                        <!-- 現在のアイキャッチ画像表示 -->
                        {% if article and article.featured_image %}
                        <div class="current-featured-image mb-3">
                            <div class="position-relative d-inline-block">
                                <img src="{{ url_for('static', filename=article.featured_image) }}" 
                                     alt="現在のアイキャッチ画像" 
                                     class="img-fluid rounded"
                                     style="max-height: 200px; max-width: 100%;">
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                                        onclick="removeFeaturedImage()" title="画像を削除">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                            <small class="text-muted d-block mt-1">現在のアイキャッチ画像</small>
                        </div>
                        {% endif %}
                        
                        <!-- ファイル選択 -->
                        <div class="mb-3">
                            <input type="file" class="form-control" id="featured_image_file" name="featured_image" 
                                   accept="image/*" onchange="previewFeaturedImage(event)">
                            <div class="form-text">推奨サイズ: 800×450px (16:9比率) | JPG、PNG、GIF形式をサポート</div>
                        </div>
                        
                        <!-- プレビューエリア -->
                        <div id="featuredImagePreviewContainer" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">画像プレビュー</label>
                                <div class="text-center">
                                    <img id="featuredImagePreview" class="img-fluid rounded" style="max-height: 300px;">
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="openFeaturedImageCropModal()">
                                        <i class="fa fa-crop me-1"></i>画像をトリミング
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- トリミング座標の隠しフィールド -->
                        <input type="hidden" id="featured_crop_x" name="featured_crop_x">
                        <input type="hidden" id="featured_crop_y" name="featured_crop_y">
                        <input type="hidden" id="featured_crop_width" name="featured_crop_width">
                        <input type="hidden" id="featured_crop_height" name="featured_crop_height">
                    </div>
                    <div class="form-floating mb-3">
                        {{ form.meta_title(class="form-control", placeholder="メタタイトル") }}
                        <label for="meta_title">メタタイトル</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        {{ form.meta_description(class="form-control", placeholder="メタディスクリプション", rows="3") }}
                        <label for="meta_description">メタディスクリプション</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        {{ form.meta_keywords(class="form-control", placeholder="キーワード1, キーワード2") }}
                        <label for="meta_keywords">メタキーワード</label>
                    </div>
                    
                    <div class="form-floating">
                        {{ form.canonical_url(class="form-control", placeholder="https://example.com/canonical-url") }}
                        <label for="canonical_url">正規URL</label>
                    </div>
                </div>
            </div>
            
            <!-- アクション -->
            <div class="card">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" name="action" value="save_draft" class="btn btn-outline-secondary">
                            <i class="fa fa-save me-1"></i>下書き保存
                        </button>
                        <button type="submit" name="action" value="publish" class="btn btn-primary">
                            <i class="fa fa-paper-plane me-1"></i>{{ '更新' if article else '公開' }}
                        </button>
                    </div>
                    
                    {% if article %}
                    <div class="mt-3 pt-3 border-top">
                        <a href="{{ url_for('admin.articles') }}" class="btn btn-link text-muted">
                            <i class="fa fa-arrow-left me-1"></i>記事一覧に戻る
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</form>

<!-- ブロック編集モーダル -->
<div class="modal fade" id="blockEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ブロック編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="blockEditContent">
                <!-- ブロック編集フォームがここに動的に読み込まれる -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script>
let blockSortable;
let currentEditingBlock = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeBlockEditor();
    initializeAutoSlug();
    initializeFormSync();
});

function initializeBlockEditor() {
    const blockEditor = document.getElementById('blockEditor');
    
    // Sortable.jsでドラッグ&ドロップ機能を初期化
    blockSortable = Sortable.create(blockEditor, {
        handle: '.block-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        onEnd: function(evt) {
            updateBlockOrder();
        }
    });
}

function initializeFormSync() {
    // チェックボックスとhiddenフィールドの同期
    const isPublishedCheck = document.getElementById('is_published_check');
    const allowCommentsCheck = document.getElementById('allow_comments_check');
    const isPublishedHidden = document.getElementById('is_published');
    const allowCommentsHidden = document.getElementById('allow_comments');
    
    if (isPublishedCheck && isPublishedHidden) {
        // 初期値設定（hiddenフィールドの値に基づいてチェックボックスを設定）
        if (isPublishedHidden.value === 'true') {
            isPublishedCheck.checked = true;
        }
        
        // チェックボックス変更時の同期
        isPublishedCheck.addEventListener('change', function() {
            isPublishedHidden.value = this.checked ? 'true' : 'false';
            console.log('Published status changed:', this.checked);
        });
    }
    
    if (allowCommentsCheck && allowCommentsHidden) {
        // 初期値設定（hiddenフィールドの値に基づいてチェックボックスを設定）
        if (allowCommentsHidden.value === 'true') {
            allowCommentsCheck.checked = true;
        }
        
        // チェックボックス変更時の同期
        allowCommentsCheck.addEventListener('change', function() {
            allowCommentsHidden.value = this.checked ? 'true' : 'false';
            console.log('Comments setting changed:', this.checked);
        });
    }
}

function addBlock(blockType) {
    console.log('=== addBlock function called ===');
    console.log('blockType:', blockType);
    
    // 新規記事の場合は先に記事を作成する
    const articleId = '{{ article.id if article else "" }}';
    console.log('articleId:', articleId);
    
    if (!articleId) {
        // 新規記事の場合は先に記事を保存
        const titleField = document.getElementById('title');
        if (!titleField.value.trim()) {
            alert('ブロックを追加する前に記事タイトルを入力してください。');
            titleField.focus();
            return;
        }
        
        // 記事の作成を先に行う
        createArticleAndAddBlock(blockType);
        return;
    }
    
    // 既存記事の場合は通常のブロック追加
    console.log('Sending request to add block...');
    console.log('URL:', '{{ url_for("admin.add_block") }}');
    console.log('Data:', {article_id: articleId, block_type: blockType});
    
    fetch('{{ url_for("admin.add_block") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            article_id: articleId,
            block_type: blockType
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        console.log('Response ok:', response.ok);
        
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Server error response:', text);
                throw new Error(`HTTP ${response.status}: ${text}`);
            });
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // 新しいブロックをエディタに追加
            const blockEditor = document.getElementById('blockEditor');
            const emptyMessage = blockEditor.querySelector('.block-editor-empty');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            blockEditor.insertAdjacentHTML('beforeend', data.block_html);
            
            // 新しく追加されたブロックの編集画面を開く
            editBlock(data.block_id);
        } else {
            alert('ブロックの追加に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Error details:', error);
        alert('ブロックの追加中にエラーが発生しました: ' + error.message);
    });
}

function editBlock(blockId) {
    currentEditingBlock = blockId;
    
    // ブロック編集フォームを取得
    fetch('{{ url_for("admin.edit_block") }}?block_id=' + blockId)
    .then(response => response.text())
    .then(html => {
        document.getElementById('blockEditContent').innerHTML = html;
        
        const modal = new bootstrap.Modal(document.getElementById('blockEditModal'));
        modal.show();
        
        // フォーム内のイベントリスナーを初期化
        initializeBlockForm();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ブロック編集画面の読み込みに失敗しました');
    });
}

function deleteBlock(blockId) {
    if (!confirm('このブロックを削除してもよろしいですか？')) {
        return;
    }
    
    fetch('{{ url_for("admin.delete_block") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            block_id: blockId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // DOMからブロックを削除
            const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
            if (blockElement) {
                blockElement.remove();
            }
            
            // エディタが空になった場合は空メッセージを表示
            const blockEditor = document.getElementById('blockEditor');
            if (blockEditor.children.length === 0) {
                blockEditor.innerHTML = `
                    <div class="block-editor-empty">
                        <i class="fa fa-plus-circle fa-3x mb-3"></i>
                        <h5>最初のブロックを追加してください</h5>
                        <p class="text-muted">右側のパネルからブロックタイプを選択して記事を作成しましょう</p>
                    </div>
                `;
            }
        } else {
            alert('ブロックの削除に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ブロックの削除中にエラーが発生しました');
    });
}

function updateBlockOrder() {
    const blockElements = document.querySelectorAll('.block-item[data-block-id]');
    const blockIds = Array.from(blockElements).map(el => el.dataset.blockId);
    
    fetch('{{ url_for("admin.reorder_blocks") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            block_ids: blockIds
        })
    })
    .catch(error => {
        console.error('Block reorder error:', error);
    });
}

function updateBlockPreview(blockId, previewHtml) {
    // プレビューエリアが存在するかチェック
    let previewArea = document.getElementById('article-preview');
    if (!previewArea) {
        // プレビューエリアが存在しない場合は作成
        createPreviewArea();
        previewArea = document.getElementById('article-preview');
    }
    
    // 既存のブロックプレビューを更新または追加
    let blockPreview = previewArea.querySelector(`[data-preview-block-id="${blockId}"]`);
    if (blockPreview) {
        blockPreview.innerHTML = previewHtml;
    } else {
        // 新しいプレビューブロックを作成
        const newBlockPreview = document.createElement('div');
        newBlockPreview.setAttribute('data-preview-block-id', blockId);
        newBlockPreview.innerHTML = previewHtml;
        previewArea.appendChild(newBlockPreview);
    }
    
    // プレビューエリアを表示
    if (previewArea.style.display === 'none') {
        previewArea.style.display = 'block';
    }
}

function createPreviewArea() {
    const rightColumn = document.querySelector('.col-lg-4');
    if (rightColumn) {
        const previewCard = `
            <div class="card mb-4" id="preview-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fa fa-eye me-2"></i>ブロックプレビュー</h6>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="togglePreview()">
                        <i class="fa fa-eye-slash" id="preview-toggle-icon"></i>
                    </button>
                </div>
                <div class="card-body" id="article-preview" style="max-height: 500px; overflow-y: auto;">
                    <div class="text-muted text-center p-3">
                        <i class="fa fa-eye fa-2x mb-2"></i>
                        <p>ブロックを保存するとプレビューが表示されます</p>
                    </div>
                </div>
            </div>
        `;
        
        // 公開設定カードの前に挿入
        const publishCard = rightColumn.querySelector('.card');
        if (publishCard) {
            publishCard.insertAdjacentHTML('beforebegin', previewCard);
        } else {
            rightColumn.insertAdjacentHTML('afterbegin', previewCard);
        }
    }
}

function togglePreview() {
    const previewArea = document.getElementById('article-preview');
    const toggleIcon = document.getElementById('preview-toggle-icon');
    
    if (previewArea.style.display === 'none') {
        previewArea.style.display = 'block';
        toggleIcon.className = 'fa fa-eye-slash';
    } else {
        previewArea.style.display = 'none';
        toggleIcon.className = 'fa fa-eye';
    }
}

function addFeaturedImageBlock() {
    if (!confirm('アイキャッチ画像ブロックを追加しますか？')) {
        return;
    }
    
    const articleId = {{ article.id if article else 'null' }};
    if (!articleId) {
        // 新規記事の場合は先に記事を作成する
        const titleField = document.getElementById('title');
        if (!titleField.value.trim()) {
            alert('アイキャッチ画像を追加する前に記事タイトルを入力してください。');
            titleField.focus();
            return;
        }
        
        // 記事の作成を先に行う
        createArticleAndAddFeaturedBlock();
        return;
    }
    
    fetch('{{ url_for("admin.add_block") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            article_id: articleId,
            block_type: 'featured_image'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // ページを再読み込みして変更を反映
        } else {
            alert('アイキャッチブロックの追加に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Featured block add error:', error);
        alert('アイキャッチブロックの追加中にエラーが発生しました');
    });
}

function createArticleAndAddFeaturedBlock() {
    // 新規記事を作成してからアイキャッチブロックを追加
    const form = document.getElementById('blockEditorForm');
    
    // チェックボックスの値を隠しフィールドに反映
    updateHiddenFields();
    
    const formData = new FormData(form);
    
    // 下書きとして保存
    formData.set('action', 'save_draft');
    
    // 明示的にURLを指定
    const actionUrl = '{{ url_for("admin.create_article_block_editor") }}';
    
    fetch(actionUrl, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok && response.redirected) {
            // 記事が作成され、編集ページにリダイレクトされた
            window.location.href = response.url + '?add_block=featured_image';
        } else if (response.ok) {
            // レスポンスは成功だが、リダイレクトされていない（エラーがある可能性）
            return response.text().then(text => {
                if (text.includes('danger') || text.includes('error')) {
                    alert('記事の作成に失敗しました。タイトルなど必要な項目を入力してください。');
                } else {
                    // 成功したが何らかの理由でリダイレクトされなかった
                    location.reload();
                }
            });
        } else {
            alert('記事の作成に失敗しました。ステータス: ' + response.status);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('記事の作成中にエラーが発生しました: ' + error.message);
    });
}

function saveBlock() {
    const form = document.getElementById('blockEditForm');
    if (!form) return;
    
    const formData = new FormData(form);
    
    fetch('{{ url_for("admin.save_block") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ブロックの表示を更新
            const blockElement = document.querySelector(`[data-block-id="${currentEditingBlock}"]`);
            if (blockElement && data.block_html) {
                blockElement.outerHTML = data.block_html;
            }
            
            // プレビューエリアを更新
            if (data.preview_html) {
                updateBlockPreview(currentEditingBlock, data.preview_html);
            }
            
            // モーダルを閉じる
            const modal = bootstrap.Modal.getInstance(document.getElementById('blockEditModal'));
            modal.hide();
        } else {
            alert('ブロックの保存に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ブロックの保存中にエラーが発生しました');
    });
}

function initializeBlockForm() {
    // ブロック編集フォーム内の特殊な機能を初期化
    // 画像プレビュー、トリミング機能など
}

function updateBlockAfterSave(data) {
    // ブロックの表示を更新
    if (currentEditingBlock && data.block_html) {
        const blockElement = document.querySelector(`[data-block-id="${currentEditingBlock}"]`);
        if (blockElement) {
            blockElement.outerHTML = data.block_html;
        }
    }
    
    // プレビューエリアを更新
    if (currentEditingBlock && data.preview_html) {
        updateBlockPreview(currentEditingBlock, data.preview_html);
    }
    
    // 記事のプレビューを更新
    updateArticlePreview();
}

function updateArticlePreview() {
    // 記事全体のプレビューを更新する関数
    // プレビューエリアの全体的な更新処理
    const previewArea = document.getElementById('article-preview');
    if (previewArea) {
        // ここで記事全体のプレビューを更新する処理を実装
        console.log('Article preview updated');
    }
}

function initializeAutoSlug() {
    const titleField = document.getElementById('title');
    const slugField = document.getElementById('slug');
    
    if (titleField && slugField) {
        titleField.addEventListener('input', function() {
            if (!slugField.value || slugField.dataset.autoGenerated) {
                const slug = generateSlug(this.value);
                slugField.value = slug;
                slugField.dataset.autoGenerated = 'true';
            }
        });
        
        slugField.addEventListener('input', function() {
            this.dataset.autoGenerated = 'false';
        });
    }
}

function generateSlug(text) {
    return text
        .toLowerCase()
        .replace(/[^\w\s-]/g, '')
        .replace(/[\s_-]+/g, '-')
        .replace(/^-+|-+$/g, '');
}

function updateHiddenFields() {
    // チェックボックスの値を隠しフィールドに反映
    const isPublishedCheck = document.getElementById('is_published_check');
    const allowCommentsCheck = document.getElementById('allow_comments_check');
    
    // 隠しフィールドがない場合は作成
    let isPublishedHidden = document.querySelector('input[name="is_published"]');
    if (!isPublishedHidden) {
        isPublishedHidden = document.createElement('input');
        isPublishedHidden.type = 'hidden';
        isPublishedHidden.name = 'is_published';
        document.getElementById('blockEditorForm').appendChild(isPublishedHidden);
    }
    
    let allowCommentsHidden = document.querySelector('input[name="allow_comments"]');
    if (!allowCommentsHidden) {
        allowCommentsHidden = document.createElement('input');
        allowCommentsHidden.type = 'hidden';
        allowCommentsHidden.name = 'allow_comments';
        document.getElementById('blockEditorForm').appendChild(allowCommentsHidden);
    }
    
    // 値を設定
    isPublishedHidden.value = isPublishedCheck.checked ? 'true' : 'false';
    allowCommentsHidden.value = allowCommentsCheck.checked ? 'true' : 'false';
}

function createArticleAndAddBlock(blockType) {
    // 新規記事を作成してからブロックを追加
    const form = document.getElementById('blockEditorForm');
    
    // チェックボックスの値を隠しフィールドに反映
    updateHiddenFields();
    
    const formData = new FormData(form);
    
    // 下書きとして保存
    formData.set('action', 'save_draft');
    
    // 明示的にURLを指定
    const actionUrl = '{{ url_for("admin.create_article_block_editor") }}';
    
    fetch(actionUrl, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok && response.redirected) {
            // 記事が作成され、編集ページにリダイレクトされた
            window.location.href = response.url + '?add_block=' + blockType;
        } else if (response.ok) {
            // レスポンスは成功だが、リダイレクトされていない（エラーがある可能性）
            return response.text().then(text => {
                if (text.includes('danger') || text.includes('error')) {
                    alert('記事の作成に失敗しました。タイトルなど必要な項目を入力してください。');
                } else {
                    // 成功したが何らかの理由でリダイレクトされなかった
                    location.reload();
                }
            });
        } else {
            alert('記事の作成に失敗しました。ステータス: ' + response.status);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('記事の作成中にエラーが発生しました: ' + error.message);
    });
}

// アイキャッチ画像関連の関数
let featuredImageCropper = null;

function previewFeaturedImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('featuredImagePreview');
            const container = document.getElementById('featuredImagePreviewContainer');
            preview.src = e.target.result;
            container.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

function openFeaturedImageCropModal() {
    const preview = document.getElementById('featuredImagePreview');
    if (!preview || !preview.src) {
        alert('まず画像を選択してください');
        return;
    }
    
    // モーダル内の画像に設定
    const cropImage = document.getElementById('featuredCropImage');
    cropImage.src = preview.src;
    
    // モーダルを表示
    const modal = new bootstrap.Modal(document.getElementById('featuredImageCropModal'));
    modal.show();
    
    // モーダルが完全に表示されてからCropper.jsを初期化
    document.getElementById('featuredImageCropModal').addEventListener('shown.bs.modal', function () {
        if (featuredImageCropper) {
            featuredImageCropper.destroy();
        }
        
        featuredImageCropper = new Cropper(cropImage, {
            aspectRatio: 16 / 9, // 16:9比率
            viewMode: 1,
            dragMode: 'crop',
            autoCropArea: 0.7,
            responsive: true,
            modal: true,
            guides: true,
            center: true,
            highlight: true,
            background: true,
            autoCrop: true,
            movable: true,
            zoomable: true,
            zoomOnWheel: true,
            cropBoxMovable: true,
            cropBoxResizable: true,
            minCropBoxWidth: 100,
            minCropBoxHeight: 56 // 16:9の場合は100*(9/16)=56
        });
    }, { once: true });
}

// アイキャッチ画像トリミング操作関数
function featuredCropperZoomIn() {
    if (featuredImageCropper) featuredImageCropper.zoom(0.1);
}

function featuredCropperZoomOut() {
    if (featuredImageCropper) featuredImageCropper.zoom(-0.1);
}

function featuredCropperMoveLeft() {
    if (featuredImageCropper) featuredImageCropper.move(-10, 0);
}

function featuredCropperMoveRight() {
    if (featuredImageCropper) featuredImageCropper.move(10, 0);
}

function featuredCropperMoveUp() {
    if (featuredImageCropper) featuredImageCropper.move(0, -10);
}

function featuredCropperMoveDown() {
    if (featuredImageCropper) featuredImageCropper.move(0, 10);
}

function featuredCropperReset() {
    if (featuredImageCropper) featuredImageCropper.reset();
}

function applyFeaturedImageCrop() {
    if (!featuredImageCropper) {
        alert('トリミングが開始されていません');
        return;
    }
    
    // トリミング情報を取得
    const cropData = featuredImageCropper.getData();
    
    // 隠しフィールドに値を設定
    document.getElementById('featured_crop_x').value = Math.round(cropData.x);
    document.getElementById('featured_crop_y').value = Math.round(cropData.y);
    document.getElementById('featured_crop_width').value = Math.round(cropData.width);
    document.getElementById('featured_crop_height').value = Math.round(cropData.height);
    
    // プレビュー画像を更新
    const canvas = featuredImageCropper.getCroppedCanvas({
        width: 400,
        height: 225 // 16:9比率
    });
    
    document.getElementById('featuredImagePreview').src = canvas.toDataURL();
    
    // モーダルを閉じる
    const modal = bootstrap.Modal.getInstance(document.getElementById('featuredImageCropModal'));
    modal.hide();
    
    // Cropperインスタンスをクリーンアップ
    featuredImageCropper.destroy();
    featuredImageCropper = null;
}

function removeFeaturedImage() {
    if (confirm('アイキャッチ画像を削除しますか？')) {
        // サーバーに削除リクエストを送信
        fetch('{{ url_for("admin.remove_featured_image") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                article_id: {{ article.id if article else 'null' }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('画像の削除に失敗しました');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('削除中にエラーが発生しました');
        });
    }
}

function previewArticle() {
    // プレビュー機能（別ウィンドウで記事プレビューを表示）
    const articleId = '{{ article.id if article else "" }}';
    if (articleId) {
        window.open('{{ url_for("admin.article_preview", article_id=article.id if article else 0) }}', '_blank');
    } else {
        alert('記事を保存してからプレビューしてください');
    }
}

// モーダル内のフォーム用のJavaScript関数
function saveBlockFromModal() {
    const form = document.getElementById('blockEditContent').querySelector('#blockEditForm');
    if (!form) {
        alert('フォームが見つかりません');
        return;
    }
    
    const formData = new FormData(form);
    
    fetch('/admin/api/block/save', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ブロックリストを更新
            if (data.block_html && currentEditingBlock) {
                updateBlockAfterSave(data);
            }
            
            // モーダルを閉じる
            const modal = bootstrap.Modal.getInstance(document.getElementById('blockEditModal'));
            if (modal) {
                modal.hide();
            }
            
            alert('ブロックが保存されました');
        } else {
            alert('ブロックの保存に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ブロックの保存中にエラーが発生しました');
    });
}

function fetchSNSOGPPreview() {
    const modalContent = document.getElementById('blockEditContent');
    const urlInput = modalContent.querySelector('#embed_url');
    
    if (!urlInput) {
        alert('URLフィールドが見つかりません');
        return;
    }
    
    const url = urlInput.value.trim();
    
    if (!url) {
        alert('SNS投稿URLを入力してください');
        return;
    }
    
    if (!isValidURL(url)) {
        alert('有効なURLを入力してください');
        return;
    }
    
    // ローディング表示
    const button = modalContent.querySelector('#fetchOGPBtn');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i>取得中...';
    button.disabled = true;
    
    // CSRFトークンを取得
    const csrfToken = modalContent.querySelector('input[name="csrf_token"]');
    if (!csrfToken) {
        alert('CSRFトークンが見つかりません');
        button.innerHTML = originalText;
        button.disabled = false;
        return;
    }
    
    // サーバーサイドのOGP取得APIを呼び出し
    fetch('/admin/api/fetch-ogp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.value
        },
        body: JSON.stringify({ url: url })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySNSOGPPreview(data.ogp_data, modalContent);
            fillSNSOGPFields(data.ogp_data, modalContent);
            
            // OGPカード表示モードに自動切り替え
            const ogpCardRadio = modalContent.querySelector('#display_mode_ogp');
            if (ogpCardRadio) {
                ogpCardRadio.checked = true;
                toggleOGPCardSettings(modalContent);
            }
        } else {
            alert('OGP情報の取得に失敗しました: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('SNS OGP fetch error:', error);
        alert('OGP情報の取得中にエラーが発生しました');
    })
    .finally(() => {
        // ボタンを元に戻す
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function fetchOGPPreview() {
    const modalContent = document.getElementById('blockEditContent');
    const urlInput = modalContent.querySelector('#external_url');
    
    if (!urlInput) {
        alert('URLフィールドが見つかりません');
        return;
    }
    
    const url = urlInput.value.trim();
    
    if (!url) {
        alert('URLを入力してください');
        return;
    }
    
    if (!isValidURL(url)) {
        alert('有効なURLを入力してください');
        return;
    }
    
    // ローディング表示 - ボタンを正しく取得
    const button = modalContent.querySelector('button[onclick*="fetchOGPPreview"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i>取得中...';
    button.disabled = true;
    
    // CSRFトークンを取得
    const csrfToken = modalContent.querySelector('input[name="csrf_token"]');
    if (!csrfToken) {
        alert('CSRFトークンが見つかりません');
        button.innerHTML = originalText;
        button.disabled = false;
        return;
    }
    
    // サーバーサイドのOGP取得APIを呼び出し
    fetch('/admin/api/fetch-ogp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.value
        },
        body: JSON.stringify({ url: url })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayOGPPreview(data.ogp_data, modalContent);
            fillOGPFields(data.ogp_data, modalContent);
        } else {
            alert('OGP情報の取得に失敗しました: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('OGP fetch error:', error);
        alert('OGP情報の取得中にエラーが発生しました');
    })
    .finally(() => {
        // ボタンを元に戻す
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function displaySNSOGPPreview(ogpData, context) {
    const preview = context.querySelector('#snsOgpPreview');
    const content = context.querySelector('#snsOgpPreviewContent');
    
    if (preview && content) {
        content.innerHTML = `
            <div class="d-flex">
                ${ogpData.image ? `<img src="${ogpData.image}" alt="OGP画像" class="me-3" style="width: 80px; height: 80px; object-fit: cover;">` : ''}
                <div>
                    <h6 class="mb-1">${ogpData.title || '(タイトルなし)'}</h6>
                    ${ogpData.description ? `<p class="mb-1 text-muted small">${ogpData.description.substring(0, 100)}${ogpData.description.length > 100 ? '...' : ''}</p>` : ''}
                    <small class="text-muted">${ogpData.site_name || 'SNS投稿'}</small>
                </div>
            </div>
        `;
        
        preview.style.display = 'block';
    }
}

function fillSNSOGPFields(ogpData, context) {
    // 空欄の場合のみ自動入力
    const titleField = context.querySelector('#sns_ogp_title');
    const descField = context.querySelector('#sns_ogp_description');
    const siteField = context.querySelector('#sns_ogp_site_name');
    const imageField = context.querySelector('#sns_ogp_image');
    
    if (titleField && !titleField.value.trim()) {
        titleField.value = ogpData.title || '';
    }
    
    if (descField && !descField.value.trim()) {
        descField.value = ogpData.description || '';
    }
    
    if (siteField && !siteField.value.trim()) {
        siteField.value = ogpData.site_name || '';
    }
    
    if (imageField && !imageField.value.trim()) {
        imageField.value = ogpData.image || '';
    }
}

function displayOGPPreview(ogpData, context) {
    const preview = context.querySelector('#ogpPreview');
    const content = context.querySelector('#ogpPreviewContent');
    
    content.innerHTML = `
        <h6 class="card-title">${ogpData.title || '(タイトルなし)'}</h6>
        <p class="card-text text-muted small">${ogpData.description || '(説明なし)'}</p>
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">${ogpData.site_name || '(サイト名なし)'}</small>
            <small class="text-success"><i class="fa fa-check me-1"></i>取得完了</small>
        </div>
    `;
    
    preview.style.display = 'block';
}

function fillOGPFields(ogpData, context) {
    // 空欄の場合のみ自動入力
    const titleField = context.querySelector('#ogp_title');
    const descField = context.querySelector('#ogp_description');
    const siteField = context.querySelector('#ogp_site_name');
    
    if (titleField && !titleField.value.trim()) {
        titleField.value = ogpData.title || '';
    }
    
    if (descField && !descField.value.trim()) {
        descField.value = ogpData.description || '';
    }
    
    if (siteField && !siteField.value.trim()) {
        siteField.value = ogpData.site_name || '';
    }
}

function toggleOGPCardSettings(context) {
    context = context || document;
    const ogpCardSettings = context.querySelector('#ogpCardSettings');
    const isOGPCardMode = context.querySelector('#display_mode_ogp') && context.querySelector('#display_mode_ogp').checked;
    
    if (ogpCardSettings) {
        ogpCardSettings.style.display = isOGPCardMode ? 'block' : 'none';
    }
}

function isValidURL(string) {
    try {
        new URL(string);
        return true;
    } catch (_) {
        return false;
    }
}
</script>

<!-- アイキャッチ画像トリミングモーダル -->
<div class="modal fade" id="featuredImageCropModal" tabindex="-1" aria-labelledby="featuredImageCropModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="featuredImageCropModalLabel">
                    <i class="fa fa-crop me-2"></i>アイキャッチ画像トリミング
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-9">
                        <div class="crop-container">
                            <img id="featuredCropImage" class="img-fluid" style="max-width: 100%;">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6>操作</h6>
                        <div class="btn-group-vertical d-grid gap-2 mb-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="featuredCropperZoomIn()">
                                <i class="fa fa-search-plus me-1"></i>拡大
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="featuredCropperZoomOut()">
                                <i class="fa fa-search-minus me-1"></i>縮小
                            </button>
                        </div>
                        
                        <h6>移動</h6>
                        <div class="row mb-3">
                            <div class="col-12 text-center">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="featuredCropperMoveUp()">
                                    <i class="fa fa-arrow-up"></i>
                                </button>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-4">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="featuredCropperMoveLeft()">
                                    <i class="fa fa-arrow-left"></i>
                                </button>
                            </div>
                            <div class="col-4 text-center">
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="featuredCropperReset()">
                                    <i class="fa fa-refresh"></i>
                                </button>
                            </div>
                            <div class="col-4 text-end">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="featuredCropperMoveRight()">
                                    <i class="fa fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 text-center">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="featuredCropperMoveDown()">
                                    <i class="fa fa-arrow-down"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>キャンセル
                </button>
                <button type="button" class="btn btn-primary" onclick="applyFeaturedImageCrop()">
                    <i class="fa fa-check me-1"></i>トリミング適用
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
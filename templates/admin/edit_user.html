{% extends "admin/layout.html" %}

{% block title %}ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">âœï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('admin.users') }}" class="btn btn-sm btn-outline-secondary">
            â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã«æˆ»ã‚‹
        </a>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<form method="POST">
    {{ csrf_token() }}
    <div class="row">
        <!-- å·¦å´ï¼šåŸºæœ¬æƒ…å ± -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ‘¤ åŸºæœ¬æƒ…å ±</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" readonly>
                                <div class="form-text">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="role" class="form-label">ğŸ›¡ï¸ æ¨©é™</label>
                                {% if user.id == current_user.id %}
                                    <input type="text" class="form-control" value="ğŸ‘‘ ç®¡ç†è€…" readonly>
                                    <input type="hidden" name="role" value="admin">
                                    <div class="form-text">è‡ªåˆ†è‡ªèº«ã®æ¨©é™ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>
                                {% else %}
                                    <select class="form-select" id="role" name="role">
                                        <option value="author" {{ 'selected' if user.role == 'author' else '' }}>ğŸ‘¤ æŠ•ç¨¿è€…</option>
                                        <option value="admin" {{ 'selected' if user.role == 'admin' else '' }}>ğŸ‘‘ ç®¡ç†è€…</option>
                                    </select>
                                {% endif %}
                                {% if user.id == current_user.id %}
                                <div class="form-text text-warning">è‡ªåˆ†ã®æ¨©é™ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">ğŸ‘¤ åå‰</label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ user.name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="handle_name" class="form-label">ğŸ·ï¸ ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ </label>
                                <input type="text" class="form-control" id="handle_name" name="handle_name" value="{{ user.handle_name or '' }}" maxlength="100">
                                <div class="form-text">å…¬é–‹æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹åå‰</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ± -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="introduction" class="form-label">ğŸ“„ ç´¹ä»‹æ–‡</label>
                        <textarea class="form-control" id="introduction" name="introduction" rows="4" maxlength="250">{{ user.introduction or '' }}</textarea>
                        <div class="form-text">æœ€å¤§250æ–‡å­—</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="birthplace" class="form-label">ğŸ  å‡ºèº«åœ°</label>
                                <input type="text" class="form-control" id="birthplace" name="birthplace" value="{{ user.birthplace or '' }}" maxlength="10">
                                <div class="form-text">æœ€å¤§10æ–‡å­—</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="birthday" class="form-label">ğŸ‚ èª•ç”Ÿæ—¥</label>
                                <input type="date" class="form-control" id="birthday" name="birthday" value="{{ user.birthday.strftime('%Y-%m-%d') if user.birthday else '' }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SNSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ”— SNSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sns_x" class="form-label">ğ• X (æ—§Twitter)</label>
                                <input type="text" class="form-control" id="sns_x" name="sns_x" value="{{ user.sns_x or '' }}" placeholder="@username">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sns_facebook" class="form-label">ğŸ“˜ Facebook</label>
                                <input type="text" class="form-control" id="sns_facebook" name="sns_facebook" value="{{ user.sns_facebook or '' }}" placeholder="username">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sns_instagram" class="form-label">ğŸ“· Instagram</label>
                                <input type="text" class="form-control" id="sns_instagram" name="sns_instagram" value="{{ user.sns_instagram or '' }}" placeholder="@username">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sns_threads" class="form-label">ğŸ§µ Threads</label>
                                <input type="text" class="form-control" id="sns_threads" name="sns_threads" value="{{ user.sns_threads or '' }}" placeholder="@username">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sns_youtube" class="form-label">ğŸ“º YouTube</label>
                                <input type="text" class="form-control" id="sns_youtube" name="sns_youtube" value="{{ user.sns_youtube or '' }}" placeholder="channel-name">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="new_password" class="form-label">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" class="form-control" id="new_password" name="new_password" minlength="8">
                        <div class="form-text">å¤‰æ›´ã™ã‚‹å ´åˆã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password">
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šè¨­å®šãƒ»çµ±è¨ˆ -->
        <div class="col-lg-4">
            <!-- é€šçŸ¥è¨­å®š -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ”” é€šçŸ¥è¨­å®š</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="notify_on_publish" name="notify_on_publish" {{ 'checked' if user.notify_on_publish else '' }}>
                        <label class="form-check-label" for="notify_on_publish">
                            ğŸ“¢ è¨˜äº‹å…¬é–‹é€šçŸ¥
                        </label>
                        <div class="form-text">è¨˜äº‹ãŒå…¬é–‹ã•ã‚ŒãŸæ™‚ã«é€šçŸ¥ã‚’å—ã‘å–ã‚‹</div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="notify_on_comment" name="notify_on_comment" {{ 'checked' if user.notify_on_comment else '' }}>
                        <label class="form-check-label" for="notify_on_comment">
                            ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥
                        </label>
                        <div class="form-text">ã‚³ãƒ¡ãƒ³ãƒˆãŒæŠ•ç¨¿ã•ã‚ŒãŸæ™‚ã«é€šçŸ¥ã‚’å—ã‘å–ã‚‹</div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>ç™»éŒ²æ—¥:</span>
                        <strong>{{ user.created_at.strftime('%Yå¹´%mæœˆ%dæ—¥') if user.created_at else 'N/A' }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>æŠ•ç¨¿è¨˜äº‹æ•°:</span>
                        <strong>{{ user.articles|length }}ä»¶</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>2æ®µéšèªè¨¼:</span>
                        <strong class="{{ 'text-success' if user.totp_enabled else 'text-warning' }}">
                            {{ 'âœ… æœ‰åŠ¹' if user.totp_enabled else 'âš ï¸ ç„¡åŠ¹' }}
                        </strong>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <div class="card">
                <div class="card-body">
                    <button type="submit" class="btn btn-primary w-100 mb-2">
                        ğŸ’¾ å¤‰æ›´ã‚’ä¿å­˜
                    </button>
                    <a href="{{ url_for('admin.users') }}" class="btn btn-secondary w-100">
                        âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts_extra %}
<script>
// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒã‚§ãƒƒã‚¯
document.getElementById('confirm_password').addEventListener('input', function() {
    const password = document.getElementById('new_password').value;
    const confirm = this.value;
    
    if (password && confirm && password !== confirm) {
        this.setCustomValidity('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
    } else {
        this.setCustomValidity('');
    }
});

// æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
document.getElementById('introduction').addEventListener('input', function() {
    const maxLength = 250;
    const currentLength = this.value.length;
    const formText = this.nextElementSibling;
    
    formText.textContent = `${currentLength}/${maxLength}æ–‡å­—`;
    formText.className = currentLength > maxLength ? 'form-text text-danger' : 'form-text';
});
</script>
{% endblock %}
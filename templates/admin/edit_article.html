{% extends "admin/layout.html" %}

{% block title %}記事編集: {{ article.title }}{% endblock %}
{% block page_title %}記事編集{% endblock %}

{% block breadcrumb %}
{{ super() }}
<li><a href="{{ url_for('admin.articles') }}">記事管理</a></li>
<li>{{ article.title[:30] }}{% if article.title|length > 30 %}...{% endif %}</li>
{% endblock %}

{% block head_extra %}
<!-- Markdown Editor Styles -->
<style>
.preview-container {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
}

.current-image-preview {
    border: 2px solid #28a745;
    border-radius: 8px;
    padding: 15px;
    background-color: #f8fff9;
}

.image-preview {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.required-field::after {
    content: " *";
    color: #dc3545;
}

/* Markdown Editor Styles */
.markdown-editor {
    min-height: 400px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
    border: 1px solid #ced4da;
    border-radius: 8px;
    padding: 1rem;
    background-color: white;
    resize: vertical;
}

.markdown-editor:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.markdown-toolbar {
    background: #f8f9fa;
    border: 1px solid #ced4da;
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    padding: 0.5rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.markdown-button {
    background: #e9ecef;
    border: 1px solid #adb5bd;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
}

.markdown-button:hover {
    background: #dee2e6;
}

.markdown-preview {
    border: 1px solid #ced4da;
    border-radius: 8px;
    padding: 1rem;
    background-color: white;
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
}

.editor-tabs {
    display: flex;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 1rem;
}

.editor-tab {
    padding: 0.5rem 1rem;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
}

.editor-tab.active {
    border-bottom-color: #0d6efd;
    color: #0d6efd;
    font-weight: 500;
}

.editor-tab:hover {
    background: #f8f9fa;
}

.editor-content {
    display: none;
}

.editor-content.active {
    display: block;
}

.sns-embed-help {
    background: #e7f3ff;
    border: 1px solid #b8daff;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.image-upload-helper {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<form method="POST" enctype="multipart/form-data" data-validate>
    {{ form.hidden_tag() }}
    
    <div class="row">
        <!-- メインコンテンツ -->
        <div class="col-lg-8">
            <!-- 基本情報 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-edit me-2"></i>記事内容（Markdownエディタ）</h5>
                </div>
                <div class="card-body">
                    <!-- タイトル -->
                    <div class="form-floating mb-3">
                        {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else ""), placeholder="記事のタイトルを入力してください", required=true) }}
                        <label for="{{ form.title.id }}" class="required-field">{{ form.title.label.text }}</label>
                        {% if form.title.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.title.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- スラッグ -->
                    <div class="form-floating mb-3">
                        {{ form.slug(class="form-control" + (" is-invalid" if form.slug.errors else ""), placeholder="url-slug") }}
                        <label for="{{ form.slug.id }}">{{ form.slug.label.text }}</label>
                        {% if form.slug.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.slug.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="fa fa-warning me-1 text-warning"></i>変更すると既存のURLが無効になる可能性があります
                        </div>
                    </div>
                    
                    <!-- 概要 -->
                    <div class="form-floating mb-3">
                        {{ form.summary(class="form-control" + (" is-invalid" if form.summary.errors else ""), placeholder="記事の概要", rows="3") }}
                        <label for="{{ form.summary.id }}">{{ form.summary.label.text }}</label>
                        {% if form.summary.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.summary.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- 本文 -->
                    <div class="mb-3">
                        <label for="body" class="form-label required-field">{{ form.body.label.text }}</label>
                        
                        <!-- SNS埋込機能ヘルプ -->
                        <div class="sns-embed-help">
                            <h6><i class="fa fa-magic me-1"></i>SNS自動埋込機能</h6>
                            <p class="mb-2 small">以下のSNS URLを1行に貼り付けると自動的に埋込表示されます：</p>
                            <ul class="mb-2 small">
                                <li><strong>YouTube:</strong> https://youtu.be/VIDEO_ID または https://www.youtube.com/watch?v=VIDEO_ID</li>
                                <li><strong>Twitter/X:</strong> https://twitter.com/user/status/TWEET_ID または https://x.com/user/status/TWEET_ID</li>
                                <li><strong>Instagram:</strong> https://www.instagram.com/p/POST_ID/</li>
                                <li><strong>Facebook:</strong> https://fb.watch/VIDEO_ID</li>
                                <li><strong>Threads:</strong> https://www.threads.net/@user/post/POST_ID （ユーザー名・投稿IDを含むカード表示）</li>
                            </ul>
                        </div>
                        
                        <!-- 画像アップロードヘルプ -->
                        <div class="image-upload-helper">
                            <h6><i class="fa fa-image me-1"></i>画像の挿入方法</h6>
                            <p class="mb-2 small">Markdownで画像を挿入する方法：</p>
                            <ul class="mb-2 small">
                                <li><code>![画像の説明](画像のURL)</code> - 外部画像のURL</li>
                                <li><code>![画像の説明](/static/uploads/image.jpg)</code> - アップロード済み画像</li>
                                <li>アイキャッチ画像は右側のサイドバーからアップロード可能</li>
                            </ul>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="showImageUploadModal()">
                                <i class="fa fa-upload me-1"></i>画像をアップロード
                            </button>
                        </div>
                        
                        <!-- エディタタブ -->
                        <div class="editor-tabs">
                            <button type="button" class="editor-tab active" onclick="switchTab('edit')">
                                <i class="fa fa-edit me-1"></i>編集
                            </button>
                            <button type="button" class="editor-tab" onclick="switchTab('preview')">
                                <i class="fa fa-eye me-1"></i>プレビュー
                            </button>
                        </div>
                        
                        <!-- Markdownツールバー -->
                        <div class="markdown-toolbar">
                            <button type="button" class="markdown-button" onclick="insertMarkdown('**', '**')" title="太字">
                                <i class="fa fa-bold"></i>
                            </button>
                            <button type="button" class="markdown-button" onclick="insertMarkdown('*', '*')" title="斜体">
                                <i class="fa fa-italic"></i>
                            </button>
                            <button type="button" class="markdown-button" onclick="insertMarkdown('# ', '')" title="見出し1">
                                H1
                            </button>
                            <button type="button" class="markdown-button" onclick="insertMarkdown('## ', '')" title="見出し2">
                                H2
                            </button>
                            <button type="button" class="markdown-button" onclick="insertMarkdown('### ', '')" title="見出し3">
                                H3
                            </button>
                            <button type="button" class="markdown-button" onclick="insertMarkdown('- ', '')" title="リスト">
                                <i class="fa fa-list"></i>
                            </button>
                            <button type="button" class="markdown-button" onclick="insertMarkdown('1. ', '')" title="番号付きリスト">
                                <i class="fa fa-list-ol"></i>
                            </button>
                            <button type="button" class="markdown-button" onclick="insertMarkdown('[', '](URL)')" title="リンク">
                                <i class="fa fa-link"></i>
                            </button>
                            <button type="button" class="markdown-button" onclick="insertMarkdown('![画像の説明](', ')')" title="画像">
                                <i class="fa fa-image"></i>
                            </button>
                            <button type="button" class="markdown-button" onclick="insertMarkdown('`', '`')" title="インラインコード">
                                <i class="fa fa-code"></i>
                            </button>
                            <button type="button" class="markdown-button" onclick="insertMarkdown('```\n', '\n```')" title="コードブロック">
                                <i class="fa fa-file-code"></i>
                            </button>
                            <button type="button" class="markdown-button" onclick="insertMarkdown('> ', '')" title="引用">
                                <i class="fa fa-quote-left"></i>
                            </button>
                        </div>
                        
                        <!-- エディタコンテンツ -->
                        <div class="editor-content active" id="edit-content">
                            {{ form.body(class="markdown-editor" + (" is-invalid" if form.body.errors else ""), placeholder="Markdownで記事の本文を入力してください...\n\n例:\n# 見出し1\n## 見出し2\n\n**太字**や*斜体*を使えます。\n\nSNS URLを貼り付けると自動的に埋込表示されます:\nhttps://youtu.be/VIDEO_ID", id="body") }}
                        </div>
                        
                        <div class="editor-content" id="preview-content">
                            <div class="markdown-preview" id="markdown-preview">
                                プレビューを表示するには「プレビュー」タブをクリックしてください。
                            </div>
                        </div>
                        
                        {% if form.body.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.body.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- SEO設定 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-search me-2"></i>SEO設定</h5>
                </div>
                <div class="card-body">
                    <div class="form-floating mb-3">
                        {{ form.meta_title(class="form-control" + (" is-invalid" if form.meta_title.errors else ""), placeholder="SEO用タイトル") }}
                        <label for="{{ form.meta_title.id }}">{{ form.meta_title.label.text }}</label>
                        {% if form.meta_title.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.meta_title.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-floating mb-3">
                        {{ form.meta_description(class="form-control" + (" is-invalid" if form.meta_description.errors else ""), placeholder="検索エンジン用の説明文", rows="2") }}
                        <label for="{{ form.meta_description.id }}">{{ form.meta_description.label.text }}</label>
                        {% if form.meta_description.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.meta_description.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-floating mb-3">
                        {{ form.meta_keywords(class="form-control" + (" is-invalid" if form.meta_keywords.errors else ""), placeholder="キーワード1, キーワード2, キーワード3") }}
                        <label for="{{ form.meta_keywords.id }}">{{ form.meta_keywords.label.text }}</label>
                        {% if form.meta_keywords.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.meta_keywords.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- サイドバー -->
        <div class="col-lg-4">
            <!-- 記事情報 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-info-circle me-2"></i>記事情報</h5>
                </div>
                <div class="card-body">
                    <dl class="row small">
                        <dt class="col-sm-4">ID:</dt>
                        <dd class="col-sm-8">{{ article.id }}</dd>
                        
                        <dt class="col-sm-4">作成日:</dt>
                        <dd class="col-sm-8">{{ article.created_at.strftime('%Y-%m-%d %H:%M') if article.created_at else 'N/A' }}</dd>
                        
                        <dt class="col-sm-4">更新日:</dt>
                        <dd class="col-sm-8">{{ article.updated_at.strftime('%Y-%m-%d %H:%M') if article.updated_at else 'N/A' }}</dd>
                        
                        <dt class="col-sm-4">投稿者:</dt>
                        <dd class="col-sm-8">{{ article.author.email if article.author else 'Unknown' }}</dd>
                    </dl>
                    
                    <div class="mt-3">
                        <a href="{{ url_for('article_detail', slug=article.slug) }}" target="_blank" class="btn btn-outline-info btn-sm me-2">
                            <i class="fa fa-external-link me-1"></i>記事を表示
                        </a>
                        <a href="{{ url_for('admin.article_preview', article_id=article.id) }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                            <i class="fa fa-eye me-1"></i>プレビュー
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- 公開設定 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-cog me-2"></i>公開設定</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ form.category_id.id }}" class="form-label">{{ form.category_id.label.text }}</label>
                        {{ form.category_id(class="form-select" + (" is-invalid" if form.category_id.errors else "")) }}
                        {% if form.category_id.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.category_id.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-check mb-3">
                        {{ form.is_published(class="form-check-input") }}
                        <label class="form-check-label" for="{{ form.is_published.id }}">
                            {{ form.is_published.label.text }}
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        {{ form.allow_comments(class="form-check-input") }}
                        <label class="form-check-label" for="{{ form.allow_comments.id }}">
                            {{ form.allow_comments.label.text }}
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- アイキャッチ画像 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-image me-2"></i>アイキャッチ画像</h5>
                </div>
                <div class="card-body">
                    <!-- 現在の画像表示 -->
                    {% if article.featured_image %}
                        <div class="mb-3">
                            <p><strong>現在の画像:</strong></p>
                            <div class="current-image-preview">
                                <img src="{{ url_for('static', filename=article.featured_image) }}?t={{ range(1, 100000) | random }}" 
                                     alt="現在のアイキャッチ画像" 
                                     class="image-preview">
                                <div class="mt-2 small text-muted">
                                    <i class="fa fa-file me-1"></i>{{ article.featured_image }}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="{{ form.featured_image.id }}" class="form-label">{{ form.featured_image.label.text }}</label>
                        {{ form.featured_image(class="form-control" + (" is-invalid" if form.featured_image.errors else ""), onchange="previewImage(event)") }}
                        {% if form.featured_image.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.featured_image.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            新しい画像をアップロードする場合のみ選択してください
                        </div>
                    </div>
                    
                    <div id="imagePreviewContainer" class="preview-container" style="display: none;">
                        <img id="imagePreview" class="image-preview" alt="プレビュー">
                        <div class="mt-2">
                            <small class="text-muted">新しい画像のプレビュー</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 編集のヒント -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-lightbulb me-2"></i>編集のヒント</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li class="mb-2"><i class="fa fa-exclamation-triangle text-warning me-2"></i>スラッグの変更は慎重に</li>
                        <li class="mb-2"><i class="fa fa-check text-success me-2"></i>定期的に保存することを推奨</li>
                        <li class="mb-2"><i class="fa fa-check text-success me-2"></i>プレビューで表示を確認</li>
                        <li class="mb-2"><i class="fa fa-check text-success me-2"></i>SEO設定で検索順位向上</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- アクションボタン -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted">
                            <i class="fa fa-info-circle me-1"></i>
                            変更内容を確認して記事を更新してください
                        </div>
                        <div>
                            <a href="{{ url_for('admin.articles') }}" class="btn btn-secondary me-2">
                                <i class="fa fa-times me-1"></i>キャンセル
                            </a>
                            {% if article.is_published %}
                                <button type="submit" name="action" value="draft" class="btn btn-warning me-2" onclick="setPublishStatus(false)">
                                    <i class="fa fa-archive me-1"></i>下書きに戻す
                                </button>
                                <button type="submit" name="action" value="publish" class="btn btn-primary" onclick="setPublishStatus(true)">
                                    <i class="fa fa-save me-1"></i>更新する
                                </button>
                            {% else %}
                                <button type="submit" name="action" value="draft" class="btn btn-warning me-2" onclick="setPublishStatus(false)">
                                    <i class="fa fa-save me-1"></i>下書き保存
                                </button>
                                <button type="submit" name="action" value="publish" class="btn btn-primary" onclick="setPublishStatus(true)">
                                    <i class="fa fa-upload me-1"></i>公開する
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts_extra %}
<script>
// Markdownエディタの機能

// タブ切り替え
function switchTab(tab) {
    // タブボタンの状態変更
    document.querySelectorAll('.editor-tab').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');
    
    // コンテンツの表示切り替え
    document.querySelectorAll('.editor-content').forEach(content => content.classList.remove('active'));
    
    if (tab === 'edit') {
        document.getElementById('edit-content').classList.add('active');
    } else if (tab === 'preview') {
        document.getElementById('preview-content').classList.add('active');
        updatePreview();
    }
}

// Markdownプレビュー更新
function updatePreview() {
    const markdownText = document.getElementById('body').value;
    const previewDiv = document.getElementById('markdown-preview');
    
    if (!markdownText.trim()) {
        previewDiv.innerHTML = '<p class="text-muted">プレビューを表示するには本文を入力してください。</p>';
        return;
    }
    
    // サーバーサイドでMarkdownを処理するため、フォームデータを送信
    const formData = new FormData();
    formData.append('markdown_text', markdownText);
    
    fetch('/admin/preview_markdown', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        }
    })
    .then(response => response.text())
    .then(html => {
        previewDiv.innerHTML = html;
    })
    .catch(error => {
        console.error('Preview error:', error);
        previewDiv.innerHTML = '<p class="text-danger">プレビューの表示に失敗しました。</p>';
    });
}

// Markdownツールバー機能
function insertMarkdown(before, after) {
    const textarea = document.getElementById('body');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    const replacement = before + selectedText + after;
    
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    
    // カーソル位置を調整
    const newCursorPos = start + before.length + selectedText.length;
    textarea.focus();
    textarea.setSelectionRange(newCursorPos, newCursorPos);
}

// 画像アップロードモーダル（簡易版）
function showImageUploadModal() {
    const imageUrl = prompt('画像のURLを入力してください（例: /static/uploads/image.jpg）:');
    if (imageUrl) {
        const imageText = prompt('画像の説明文を入力してください（alt属性）:', '画像');
        insertMarkdown(`![${imageText}](`, `${imageUrl})`);
    }
}

// 画像プレビュー
function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('imagePreview');
            const container = document.getElementById('imagePreviewContainer');
            preview.src = e.target.result;
            container.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

// フォーム送信前の確認
document.querySelector('form').addEventListener('submit', function(e) {
    const title = document.getElementById('{{ form.title.id }}').value.trim();
    const body = document.getElementById('body').value.trim();
    
    if (!title) {
        e.preventDefault();
        alert('タイトルを入力してください。');
        return false;
    }
    
    if (!body) {
        e.preventDefault();
        alert('本文を入力してください。');
        return false;
    }
});

// 公開状態を設定する関数
function setPublishStatus(isPublished) {
    const publishCheckbox = document.getElementById('{{ form.is_published.id }}');
    if (publishCheckbox) {
        publishCheckbox.checked = isPublished;
    }
}

// キーボードショートカット
document.getElementById('body').addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 'b':
                e.preventDefault();
                insertMarkdown('**', '**');
                break;
            case 'i':
                e.preventDefault();
                insertMarkdown('*', '*');
                break;
            case 'k':
                e.preventDefault();
                insertMarkdown('[', '](URL)');
                break;
        }
    }
});

// オートセーブ機能（オプション）
let autoSaveTimeout;
document.getElementById('body').addEventListener('input', function() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        // ここで自動保存の処理を実装可能
        console.log('Auto-save triggered');
    }, 5000); // 5秒後に自動保存
});
</script>
{% endblock %}
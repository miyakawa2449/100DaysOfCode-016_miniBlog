{% extends "admin/layout.html" %}

{% block title %}アクセスログ分析{% endblock %}
{% block page_title %}アクセスログ分析{% endblock %}

{% block breadcrumb %}
{{ super() }}
<li>ツール</li>
<li>アクセスログ分析</li>
{% endblock %}

{% block head_extra %}
<style>
.logs-container {
    max-width: 1200px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stats-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-color);
}

.stats-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 8px;
}

.chart-container {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}

.data-table {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}

.error-box {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}

.info-box {
    background-color: #d1ecf1;
    border: 1px solid #17a2b8;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
}

.progress {
    height: 8px;
}

.hourly-chart {
    display: flex;
    align-items: end;
    justify-content: space-between;
    height: 100px;
    padding: 10px 0;
    border-bottom: 1px solid #dee2e6;
}

.hour-bar {
    flex: 1;
    margin: 0 1px;
    background: linear-gradient(to top, var(--primary-color), #007bff);
    min-height: 2px;
    border-radius: 2px 2px 0 0;
    position: relative;
    cursor: pointer;
}

.hour-bar:hover::after {
    content: attr(data-count);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    white-space: nowrap;
}

.hour-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 5px;
}

.ranking-list {
    list-style: none;
    padding: 0;
}

.ranking-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f1f1f1;
}

.ranking-item:last-child {
    border-bottom: none;
}

.ranking-number {
    background: var(--primary-color);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}

.ranking-content {
    flex: 1;
    margin: 0 10px;
}

.ranking-count {
    font-weight: bold;
    color: var(--primary-color);
}

.refresh-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}
</style>
{% endblock %}

{% block content %}
<div class="logs-container">
    
    {% if error_message %}
        <div class="error-box">
            <h5><i class="fas fa-exclamation-triangle"></i> エラー</h5>
            <p class="mb-0">{{ error_message }}</p>
        </div>
    {% endif %}

    {% if log_files %}
        <div class="info-box">
            <h6><i class="fas fa-info-circle"></i> 分析対象ログファイル</h6>
            <p class="mb-0">
                {% for log_file in log_files %}
                    <span class="badge bg-primary">{{ log_file }}</span>{% if not loop.last %} {% endif %}
                {% endfor %}
            </p>
            <small class="text-muted">最新1000行のデータを分析しています</small>
        </div>
    {% endif %}

    {% for log_file, report in reports.items() %}
        <h5><i class="fas fa-chart-line"></i> {{ log_file }} の分析結果</h5>
        
        <!-- 基本統計 -->
        <div class="stats-grid">
            <div class="stats-card">
                <div class="stats-number">{{ "{:,}".format(report.summary.total_requests) }}</div>
                <div class="stats-label">総リクエスト数</div>
            </div>
            <div class="stats-card">
                <div class="stats-number">{{ "{:,}".format(report.summary.unique_visitors) }}</div>
                <div class="stats-label">ユニークビジター</div>
            </div>
            <div class="stats-card">
                <div class="stats-number">{{ "{:,}".format(report.summary.bot_requests) }}</div>
                <div class="stats-label">ボットアクセス</div>
            </div>
            <div class="stats-card">
                <div class="stats-number">{{ "{:,}".format(report.summary.admin_requests) }}</div>
                <div class="stats-label">管理画面アクセス</div>
            </div>
            <div class="stats-card">
                <div class="stats-number">{{ report.summary.error_rate }}%</div>
                <div class="stats-label">エラー率</div>
            </div>
            <div class="stats-card">
                <div class="stats-number">{{ "{:,}".format(report.summary.static_requests) }}</div>
                <div class="stats-label">静的ファイル</div>
            </div>
        </div>

        <!-- 時間別アクセス数 -->
        <div class="chart-container">
            <h6><i class="fas fa-clock"></i> 時間別アクセス数</h6>
            <div class="hourly-chart">
                {% set max_hourly = report.hourly_traffic.values() | list | max if report.hourly_traffic.values() else 1 %}
                {% for hour in range(24) %}
                    {% set hour_str = "{:02d}".format(hour) %}
                    {% set count = report.hourly_traffic.get(hour_str, 0) %}
                    {% set height = (count / max_hourly * 80) if max_hourly > 0 else 0 %}
                    <div class="hour-bar" 
                         style="height: {{ height }}px" 
                         data-count="{{ count }} アクセス ({{ hour_str }}:00)"></div>
                {% endfor %}
            </div>
            <div class="hour-labels">
                {% for hour in range(0, 24, 3) %}
                    <span>{{ "{:02d}".format(hour) }}:00</span>
                {% endfor %}
            </div>
        </div>

        <div class="row">
            <!-- 人気ページ -->
            <div class="col-md-6">
                <div class="data-table">
                    <h6><i class="fas fa-star"></i> 人気ページ TOP 10</h6>
                    <ul class="ranking-list">
                        {% for page, count in report.popular_pages.items() %}
                            <li class="ranking-item">
                                <div class="ranking-number">{{ loop.index }}</div>
                                <div class="ranking-content">
                                    <div class="text-truncate" title="{{ page }}">{{ page }}</div>
                                </div>
                                <div class="ranking-count">{{ "{:,}".format(count) }}</div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- ブラウザ統計 -->
            <div class="col-md-6">
                <div class="data-table">
                    <h6><i class="fas fa-globe"></i> ブラウザ統計</h6>
                    <ul class="ranking-list">
                        {% for browser, count in report.browsers.items() %}
                            <li class="ranking-item">
                                <div class="ranking-number">{{ loop.index }}</div>
                                <div class="ranking-content">{{ browser }}</div>
                                <div class="ranking-count">{{ "{:,}".format(count) }}</div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- ステータスコード -->
            <div class="col-md-6">
                <div class="data-table">
                    <h6><i class="fas fa-list-alt"></i> ステータスコード</h6>
                    <ul class="ranking-list">
                        {% for status, count in report.status_codes.items() %}
                            <li class="ranking-item">
                                <div class="ranking-content">
                                    <span class="badge 
                                        {% if status == 200 %}bg-success
                                        {% elif status >= 400 and status < 500 %}bg-warning
                                        {% elif status >= 500 %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ status }}
                                    </span>
                                </div>
                                <div class="ranking-count">{{ "{:,}".format(count) }}</div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- OS統計 -->
            <div class="col-md-6">
                <div class="data-table">
                    <h6><i class="fas fa-desktop"></i> OS統計</h6>
                    <ul class="ranking-list">
                        {% for os, count in report.operating_systems.items() %}
                            <li class="ranking-item">
                                <div class="ranking-number">{{ loop.index }}</div>
                                <div class="ranking-content">{{ os }}</div>
                                <div class="ranking-count">{{ "{:,}".format(count) }}</div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- 日別アクセス数 -->
        {% if report.daily_traffic %}
            <div class="chart-container">
                <h6><i class="fas fa-calendar-alt"></i> 日別アクセス数</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>アクセス数</th>
                                <th>グラフ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set max_daily = report.daily_traffic.values() | list | max %}
                            {% for date, count in report.daily_traffic.items() %}
                                <tr>
                                    <td>{{ date }}</td>
                                    <td>{{ "{:,}".format(count) }}</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar" 
                                                 style="width: {{ (count / max_daily * 100) if max_daily > 0 else 0 }}%"></div>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}

        <!-- データ出力 -->
        <div class="data-table">
            <h6><i class="fas fa-download"></i> データエクスポート</h6>
            <p>詳細な分析データをJSON形式でダウンロードできます。</p>
            <a href="{{ url_for('admin.download_log_report', log_file=log_file) }}" 
               class="btn btn-outline-primary" target="_blank">
                <i class="fas fa-download"></i> JSON レポートをダウンロード
            </a>
        </div>

    {% endfor %}

    {% if not reports %}
        <div class="info-box">
            <h6><i class="fas fa-info-circle"></i> 分析データなし</h6>
            <p class="mb-0">分析可能なアクセスログが見つかりませんでした。ログファイルが存在するか確認してください。</p>
        </div>
    {% endif %}

    <!-- 更新ボタン -->
    <button type="button" class="btn btn-primary refresh-button" onclick="location.reload()">
        <i class="fas fa-sync-alt"></i> 更新
    </button>

</div>
{% endblock %}

{% block script_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ツールチップの初期化
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => {
        new bootstrap.Tooltip(tooltip);
    });
    
    // 時間別グラフのインタラクション
    const hourBars = document.querySelectorAll('.hour-bar');
    hourBars.forEach(bar => {
        bar.addEventListener('click', function() {
            const count = this.getAttribute('data-count');
            alert(`アクセス数: ${count}`);
        });
    });
    
    // 自動更新（5分毎）
    setTimeout(function() {
        location.reload();
    }, 300000); // 5分 = 300,000ms
});
</script>
{% endblock %}
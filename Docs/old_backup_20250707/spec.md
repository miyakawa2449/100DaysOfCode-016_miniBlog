# ミニブログ仕様書（修正版）

**最終更新日: 2025年7月4日** - 記事編集UI改善・CSRFトークン重複問題修正完了

---

## 1. 初期設定

- サイト公開前に1回のみ実行
- 以下の情報を登録
  - 管理者ユーザ（email, name, パスワード）
  - サイトタイトル、サブタイトル
  - トップページのヘッダー画像、ロゴ画像
  - サイトURL
- 初期設定完了後、この機能は利用不可
- 運用開始後の情報更新は「サイト管理」「ユーザ管理」で行う

---

## 2. ユーザ管理・プロフィール

- ログイン・ログアウト機能
- パスワードリマインダ（パスワード再設定）機能
- Google Authenticator（TOTP）による2段階認証機能
  - ユーザごとにシークレットキーを発行・登録
  - QRコードでGoogle Authenticatorに登録
  - ログイン時に6桁コード入力による認証
- ユーザ情報  
  - email（ID兼用、ユニーク）  
  - name（本名）  
  - ハンドルネーム（公開用）  
  - パスワード（ハッシュ化保存）  
  - 紹介文（250文字以内）  
  - 出身地（10文字以内）  
  - 誕生日（yyyy年m月d日）  
  - SNSアカウント（X, Facebook, Instagram, Threads, YouTube）  
  - 権限（admin/author）
  - 記事公開通知ON/OFF
  - コメント通知ON/OFF
  - 拡張用JSON
- プロフィールページ  
  - ハンドルネーム  
  - 投稿記事一覧  
  - 紹介文  
  - 出身地  
  - 誕生日  
  - SNSアカウント（登録があれば公開）

---

## 3. 公開ページ（一般ユーザ向け）

- ホーム（新着・人気記事一覧、OGP情報出力）
- カテゴリーページ（カテゴリ別記事一覧、階層対応、OGP情報出力）
- 記事ページ（タイトル、本文、アイキャッチ画像、記事内画像、SNS埋込、外部記事OGP埋込、要約、ディスクリプション、OGP情報出力、コメント欄）
- プロフィールページ（上記参照）
- 記事編集画面・カテゴリ編集画面に「メタキーワード」「カノニカルURL」「構造化データ」入力欄を追加
- 公開ページ（記事・カテゴリ）でこれらの情報をmetaタグやJSON-LDとして出力

---

## 4. 管理画面（管理者・投稿者向け）

- ダッシュボード（統計情報、最近の投稿など）
- サイト管理  
  - サイトタイトル、サブタイトル  
  - サイトURL
  - トップページのヘッダー画像、ロゴ画像  
  - OGP用イメージ（トップページ用）  
  - サイト紹介文（OGP description用）
- ユーザ管理（ユーザ一覧、編集、削除）
- **記事管理（Markdownエディタ方式）** 🆕**実装完了**
  - 記事作成・編集・削除
  - 記事タイトル、スラッグ、要約
  - **アイキャッチ画像**
    - 16:9比率（800px × 450px）
    - Cropper.js統合によるリアルタイムトリミング
    - プレビュー表示、削除機能
  - **Markdownエディタ** 🆕**UI改善完了（2025-07-04）**
    - 完全なMarkdown対応（見出し、太字、斜体、リスト、コードブロック等）
    - リアルタイムプレビュー機能
    - ツールバーによる挿入支援
    - **統合型エディタレイアウト**
      - 記事概要とMarkdownエディタを一体化
      - 不要な空白削除によるコンパクト表示
      - ブロックエディタとの統一感ある設計
    - **画像アップロード機能**
      - 4:3比率クロッピング機能
      - Alt属性・キャプション対応
      - 自動Markdown挿入
      - CSRFトークン重複問題修正済み
    - **SNS URL自動埋込**
      - 対応: X（Twitter）、Facebook、Instagram、Threads、YouTube
      - 自動プラットフォーム検出・埋込HTML生成
      - フォールバック機能（埋込失敗時はリンク表示）
  - **記事詳細設定**
    - カテゴリー選択・新規作成
    - 公開ステータス（下書き/公開）
    - SEO設定（メタタイトル、メタディスクリプション、メタキーワード）
    - カノニカルURL、構造化データ
    - コメント許可設定
  - **プレビュー機能**
    - 専用プレビューページで実際の表示確認
    - 編集・印刷・モバイル表示切り替え
    - 下書き状態でも利用可能
- カテゴリー管理  
  - カテゴリーの作成・編集・削除  
  - カテゴリー名、親子関係（階層構造）  
  - カテゴリーURL（スラッグ）  
  - カテゴリー紹介文（OGP description用）  
  - カテゴリーOGP画像
  - メタキーワード
  - カノニカルURL
  - 構造化データ
  - 拡張用JSON
- コメント管理
  - コメント一覧・承認・削除・編集
  - スパム対策（承認制）
- エクスポート機能（CSV/JSON）
- メール通知管理

---

## 5. 技術スタック・その他

### **データベース・インフラ**（2025年7月1日最新化）
- **データベース**: MySQL 9.3.0 (プロダクション対応)
- **ORM**: SQLAlchemy 2.0.41 (非推奨パターン完全排除済み)
- **接続ドライバー**: PyMySQL 1.1.1 (AWS RDS対応)
- **マイグレーション**: Flask-Migrate (Alembic) 4.0.5

### **セキュリティ**（2025年7月1日強化完了）
- **CSRF保護**: ✅ 有効化済み（Flask-WTF）
- **認証**: Flask-Login + Google Authenticator (TOTP)
- **セキュリティヘッダー**: X-Frame-Options, X-XSS-Protection, CSP等
- **セッション管理**: 環境変数ベース設定（開発・本番分離）
- **入力検証**: HTMLサニタイゼーション、ファイルアップロード制限

### **フロントエンド・処理**
- **フレームワーク**: Python 3.10, Flask 2.x, Jinja2, Bootstrap 5
- **画像処理**: Pillow + Cropper.js（リアルタイムトリミング・リサイズ）
- **エディタ**: Markdown対応 + SNS自動埋込
- **JavaScript**: ES6+, Sortable.js, 各種UI処理

### **設定管理**（2025年7月1日改善）
- **環境変数対応**: 開発・ステージング・本番環境の完全分離
- **設定外部化**: デバッグモード、セキュリティ設定、サーバー設定
- **AWS対応**: RDS for MySQL, 環境別設定管理

### **アーキテクチャ**
- OGP情報の各ページでの動的出力（title, description, image, url）
- SNS・外部記事埋込はカード形式等で表示
- 記事本文はMarkdown形式でDBに保存（軽量・高速）
- テンプレートやCSSはBootstrap等のフレームワークに依存しすぎない構成
- カスタムフィールド追加やプラグイン機能を将来的に拡張しやすいDB設計

---

## 6. 権限管理・ユーザ種別
- 管理者（Admin）
  - 全機能へのフルアクセス
  - 全ユーザ・全記事・全カテゴリ・サイト設定の管理が可能

- 投稿者（Author）
  - 自分が作成した記事の作成・編集・削除
  - 自身のユーザ情報のみ編集可能

---

## 7. ファイルアップロードの制限
- 画像アップロード時の最大ファイルサイズ（例：2MBまで）
- 許可拡張子：jpg, jpeg, png, gif
- 不正なファイル形式やサイズ超過時はエラー表示
- 保存先ディレクトリは /uploads/images/ など

---

## 8. SEO・OGP以外のメタ情報
- 各記事・各カテゴリに meta keywords を設定可能
- サイト全体・記事・カテゴリごとに canonical URL を自動生成
- 構造化データ（JSON-LD）を記事ページに出力（記事タイトル、著者、公開日など）

---

## 9. パフォーマンス・セキュリティ（2025年7月1日強化完了）

### **セキュリティ対策**
- **CSRF対策**: ✅ 全フォームにCSRFトークン付与（再有効化済み）
- **XSS対策**: テンプレートで自動エスケープ、Markdownレンダリング時もサニタイズ
- **セキュリティヘッダー**: X-Content-Type-Options, X-Frame-Options, X-XSS-Protection, CSP等
- **セッション管理**: HTTPOnly, SameSite=Lax, 環境別HTTPS設定
- **パスワード管理**: bcryptハッシュ化、リセットトークン有効期限管理
- **2段階認証**: TOTP必須（管理者アカウント）

### **アクセス制御**
- **認証要求**: 管理画面は認証済みユーザーのみアクセス可能
- **権限管理**: 管理者・投稿者の適切な権限分離
- **API保護**: 全API エンドポイントでCSRF・認証チェック

### **環境分離・設定管理**
- **環境変数**: 開発・ステージング・本番環境の完全分離
- **設定外部化**: セキュリティ関連設定の環境別管理
- **AWS対応**: RDS接続、セキュアな本番環境設定

---

## 10. 運用・バックアップ
- データベースの定期バックアップ手順をドキュメント化
- 画像アップロードディレクトリもバックアップ対象
- 管理画面からエクスポート（CSV/JSON）機能の追加も検討

---

## 11. 拡張性
- テンプレートやCSSはBootstrap等のフレームワークに依存しすぎない構成
- カスタムフィールド追加やプラグイン機能を将来的に拡張しやすいDB設計
- 記事・ユーザ・カテゴリに「拡張用JSON」カラムを用意しておく

---

## 12. 通知機能
- 記事公開時に管理者・投稿者へメール通知（ON/OFF設定可）
- パスワードリセットやユーザ登録時にも通知メール送信
- コメント投稿時にメール通知（ON/OFF設定可）

---

## 13. コメント機能（完全実装・2025年6月30日）
- ✅ **コメント投稿機能**: 記事詳細ページでのコメント投稿フォーム
- ✅ **承認システム**: 管理者承認後の公開（スパム対策）
- ✅ **表示機能**: 承認済みコメントの記事詳細ページ表示
- ✅ **CSRFトークン対応**: セキュアなフォーム送信
- ✅ **管理画面**: コメント一覧・承認・拒否・削除機能
- ✅ **一括操作**: 効率的なコメント管理機能
- 🔄 **メール通知**: コメント投稿時の通知機能（実装予定）

---

## 14. テスト・デバッグ機能

### 自動テスト機能
- 基本機能テスト: `test_app.py`
- 2段階認証機能テスト: `test_2fa_features.py`
- 管理機能デバッグ: `debug_admin.py`
- 包括的2FA機能テスト: `complete_2fa_test.py`

### 手動テスト機能
- 詳細な手動テスト手順書: `MANUAL_TEST_STEPS.md`
- 各機能の段階的テスト方法を記載
- テスト結果の記録方法を明記

### テスト対象機能
- ユーザー認証（ログイン・ログアウト）
- 2段階認証（TOTP）の設定・認証
- 記事の作成・編集・削除
- カテゴリ管理
- 画像アップロード・トリミング
- 権限管理（管理者・投稿者）
- SEO・OGP出力機能

---

## 15. 実装状況（2025年6月30日現在）

### ✅ 完了済み機能

#### 1. ユーザ管理・プロフィール（100%）
- ✅ ログイン・ログアウト機能
- ✅ パスワードリマインダ（パスワード再設定）機能
- ✅ Google Authenticator（TOTP）による2段階認証機能
- ✅ ユーザ情報管理（email、name、ハンドルネーム、紹介文、出身地、誕生日、SNSアカウント、権限、通知設定）
- ✅ プロフィールページ（ハンドルネーム、投稿記事一覧、紹介文、出身地、誕生日、SNSアカウント）

#### 2. 管理画面（100%）
- ✅ ダッシュボード（統計情報、最近の投稿、セキュリティ状態）
- ✅ ユーザ管理（ユーザ一覧、編集、削除、権限管理）
- ✅ **Markdownエディタ記事管理（100%・2025年6月30日完全統一）**
  - ✅ HTMLエディタからMarkdownエディタへの完全移行
  - ✅ ブロック型エディタシステムの廃止
  - ✅ **新規作成・編集機能の完全統一**
  - ✅ リアルタイムMarkdownプレビュー機能
  - ✅ **画像機能の完全実装**
    - ✅ アイキャッチ画像: 16:9比率トリミング、プレビュー表示、保存機能
    - ✅ 画像アップロード: 4:3比率クロッピング、エラーハンドリング
    - ✅ Cropper.js統合: リアルタイムトリミング、ズーム機能
    - ✅ アクセシビリティ対応: aria-hidden対応、フォーカス管理
  - ✅ **SNS自動埋込機能（完全強化）**
    - ✅ YouTube: 埋込動画プレイヤー
    - ✅ Twitter/X: 両ドメイン対応、ツイート表示
    - ✅ Instagram: 投稿埋込表示
    - ✅ Facebook: 投稿・動画埋込表示
    - ✅ **Threads: OGP強化カード表示（NEW）**
  - ✅ Markdownツールバー（太字、斜体、見出し、リスト、リンク、画像、コード等）
  - ✅ タブ切り替え（編集/プレビュー）
  - ✅ キーボードショートカット対応
- ✅ カテゴリー管理（作成、編集、削除、階層構造、OGP対応）
- ✅ **コメント管理（100%・2025年6月30日実装）**
  - ✅ コメント一覧・承認・拒否・削除機能
  - ✅ 一括操作・効率的管理
  - ✅ 統計表示・承認率可視化
- ✅ 記事ステータス管理（公開/下書き切り替え）

#### 3. 公開ページ（90%・2025年6月30日改善）
- ✅ ホーム（新着記事一覧、OGP情報出力、テキストのみ表示）
- ✅ カテゴリーページ（カテゴリ別記事一覧、階層対応、OGP情報出力、テキストのみ表示）
- ✅ **記事ページ（100%実装）**
  - ✅ Markdown記事表示、OGP情報出力
  - ✅ **コメント機能**: 投稿フォーム・承認済みコメント表示
  - ✅ SNS自動埋込表示（5プラットフォーム対応）
  - ✅ SEO・OGP最適化
- ✅ プロフィールページ（ユーザ詳細、投稿記事一覧）
- 🔄 **ブロック型記事表示**（一部エラーあり、修正予定）

#### 4. セキュリティ機能（100%）
- ✅ CSRF保護
- ✅ XSS対策（HTMLサニタイゼーション）
- ✅ パスワード強度チェック
- ✅ 2段階認証（TOTP）
- ✅ セキュア画像アップロード

#### 5. 技術的機能（90%）
- ✅ レスポンシブデザイン
- ✅ SEO・OGP対応
- ✅ 画像処理・最適化
- ✅ Markdown対応
- ✅ データベースマイグレーション
- ✅ テスト機能

### 🔄 実装中・修正予定

#### 1. ブロック型エディタの改善
- 🔧 画像ブロックでのスクエアトリミング機能（画角保持）
- 🔧 アイキャッチ画像のトリミング機能強化
- 🔧 公開ページでのブロック表示エラー修正

#### 2. UI/UX改善
- 🔧 プレビュー機能の高速化
- 🔧 モバイル最適化
- 🔧 画像品質最適化

#### 6. エディタシステム改革（2025年6月27日）
- ✅ **HTMLエディタからMarkdownエディタへの完全移行**
- ✅ **ブロック型エディタシステムの廃止**
  - 複雑なブロック管理から直感的なMarkdown編集へ
  - ユーザビリティとメンテナンス性の大幅向上
- ✅ **SNS自動埋込機能の強化**
  - URLを貼り付けるだけで自動埋込表示
  - 5プラットフォーム対応（YouTube, Twitter/X, Instagram, Facebook, Threads）
- ✅ **Threads OGP機能の完全実装**
  - OGPデータ取得機能の強化
  - ユーザー名・投稿ID抽出
  - リッチカード表示（グラデーション背景、プレースホルダー画像）
  - インテリジェントフォールバック機能

### 📊 進捗統計（2025年6月30日現在）
- **全体進捗**: 約95%完了（プロダクションレベル達成）
- **実装行数**: 約17,000行
- **実装ファイル数**: 55+ファイル
- **API エンドポイント**: 35+個
- **テンプレート**: 30+個
- **JavaScript関数**: 150+個

### ✅ 2025年6月30日完了項目
1. **記事作成・編集機能の完全統一**
   - ✅ 新規作成・編集画面での機能統一
   - ✅ アイキャッチ画像機能の完全実装
   - ✅ 画像アップロード・トリミング機能統一
2. **コメント機能の完全実装**
   - ✅ 投稿・表示・管理機能
   - ✅ セキュリティ対応
3. **画像処理機能の改善**
   - ✅ エラーハンドリング強化
   - ✅ アクセシビリティ対応
   - ✅ パフォーマンス最適化

### 🎯 今後の改善予定
1. **低優先度**
   - サイト設定機能の完全実装
   - パフォーマンス最適化
   - 追加SEO機能
2. **拡張機能**
   - タグシステム
   - 検索機能
   - RSS/Atomフィード

---

# 仕様確定後の進め方

---

## 1. 画面遷移図の作成

- 必要な画面（ページ）を洗い出し、どの画面からどこへ遷移できるかを図で整理する
- 画面の全体像や必要なページを可視化し、抜け漏れ防止や実装計画に役立てる

---

## 2. データベース設計

- 仕様書をもとに、必要なテーブル・カラム・リレーションを設計する
- 画面遷移図と合わせて、どの画面でどのデータが必要かも確認する

---

## 3. 仕様書への変数名・型の明記

- 仕様書に「この項目はDBのどのカラムか」「画面上の変数名は何か」などを追記する
- 実装時の迷いを減らし、設計と実装の齟齬を防ぐ

---

## 4. ユースケース図（必要に応じて）

- 複数人開発や要件の複雑化が予想される場合は、ユースケース図があると役立つ
- 今回の規模なら必須ではないが、「誰が・どの機能を・どのように使うか」を整理したい場合は作成をおすすめ

---

## 5. テスト・品質保証

- 自動テストスクリプトの実行による機能検証
- 手動テスト手順書に従った総合的な動作確認
- セキュリティ面（2FA、CSRF対策など）の検証
- パフォーマンステスト（画像処理、データベース操作）

---

## 6. アーキテクチャの改善（2025年7月1日追加）

### **CRUD重複実装の解決**

従来の問題を解決するため、サービス層アーキテクチャを導入：

#### **サービス層統一**
- **ArticleService**: 記事作成・編集の共通処理
- **CategoryService**: カテゴリ作成・編集の共通処理  
- **UserService**: ユーザ作成・編集の共通処理（欠落機能補完）

#### **統一テンプレートシステム**
- 作成・編集で同一テンプレートを使用
- `is_edit`フラグによる条件分岐
- テンプレートサイズ76.7%削減

#### **開発効率向上**
- **保守性**: 機能変更時の修正箇所を一箇所に集約
- **テスタビリティ**: サービスメソッド単位での単体テスト
- **再利用性**: 共通ロジックの重複排除
- **拡張性**: 新機能追加時の影響範囲最小化

#### **削減効果**
- **コード行数**: 950行 → 550行 (42.1%削減)
- **テンプレートサイズ**: 125,083 bytes → 29,122 bytes (76.7%削減)
- **保守箇所**: 各機能2箇所 → 1箇所に統一

---

## おすすめの進め方

1. 画面遷移図を作成し、全体像を可視化
2. データベース設計を行い、必要なデータ構造を明確化
3. 仕様書に変数名や型を追記し、実装時の参照用にする
4. 必要に応じてユースケース図を作成し、利用者視点での機能整理を行う
5. 自動テストと手動テストを組み合わせた品質保証を実施
6. **サービス層パターンを継続活用し、将来の機能拡張に備える** ⚡New

---
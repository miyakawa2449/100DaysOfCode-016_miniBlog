# ミニブログ仕様書（修正版）

**最終更新日: 2025年6月16日**

---

## 1. 初期設定

- サイト公開前に1回のみ実行
- 以下の情報を登録
  - 管理者ユーザ（email, name, パスワード）
  - サイトタイトル、サブタイトル
  - トップページのヘッダー画像、ロゴ画像
  - サイトURL
- 初期設定完了後、この機能は利用不可
- 運用開始後の情報更新は「サイト管理」「ユーザ管理」で行う

---

## 2. ユーザ管理・プロフィール

- ログイン・ログアウト機能
- パスワードリマインダ（パスワード再設定）機能
- Google Authenticator（TOTP）による2段階認証機能
  - ユーザごとにシークレットキーを発行・登録
  - QRコードでGoogle Authenticatorに登録
  - ログイン時に6桁コード入力による認証
- ユーザ情報  
  - email（ID兼用、ユニーク）  
  - name（本名）  
  - ハンドルネーム（公開用）  
  - パスワード（ハッシュ化保存）  
  - 紹介文（250文字以内）  
  - 出身地（10文字以内）  
  - 誕生日（yyyy年m月d日）  
  - SNSアカウント（X, Facebook, Instagram, Threads, YouTube）  
  - 権限（admin/author）
  - 記事公開通知ON/OFF
  - コメント通知ON/OFF
  - 拡張用JSON
- プロフィールページ  
  - ハンドルネーム  
  - 投稿記事一覧  
  - 紹介文  
  - 出身地  
  - 誕生日  
  - SNSアカウント（登録があれば公開）

---

## 3. 公開ページ（一般ユーザ向け）

- ホーム（新着・人気記事一覧、OGP情報出力）
- カテゴリーページ（カテゴリ別記事一覧、階層対応、OGP情報出力）
- 記事ページ（タイトル、本文、アイキャッチ画像、記事内画像、SNS埋込、外部記事OGP埋込、要約、ディスクリプション、OGP情報出力、コメント欄）
- プロフィールページ（上記参照）
- 記事編集画面・カテゴリ編集画面に「メタキーワード」「カノニカルURL」「構造化データ」入力欄を追加
- 公開ページ（記事・カテゴリ）でこれらの情報をmetaタグやJSON-LDとして出力

---

## 4. 管理画面（管理者・投稿者向け）

- ダッシュボード（統計情報、最近の投稿など）
- サイト管理  
  - サイトタイトル、サブタイトル  
  - サイトURL
  - トップページのヘッダー画像、ロゴ画像  
  - OGP用イメージ（トップページ用）  
  - サイト紹介文（OGP description用）
- ユーザ管理（ユーザ一覧、編集、削除）
- 記事管理（ブロック型エディタ方式）
  - 記事作成・編集・削除
  - 記事タイトル
  - アイキャッチ画像ブロック（16:9、800px、記事先頭専用）
  - 記事本文は「ブロック」のリストとして管理
    - テキストブロック（Markdown対応）
    - 画像ブロック（1:1、400pxでトリミング・リサイズ）
    - SNS埋込ブロック（X, Facebook, Instagram, Threads, YouTube）
    - 外部記事埋込ブロック（URL入力でOGPカード化）
  - ブロックの追加・削除・並び替えが可能
  - SNSや外部記事はURLを入力すると自動で埋込ブロックに変換
  - 記事要約、ディスクリプション
  - 記事URL（スラッグ指定、例: http://hogehoge.com/xxxxxx の xxxxxx 部分を指定）
  - カテゴリー選択・新規作成・子カテゴリ追加
  - 公開ステータス（下書き/公開/公開日時指定/承認待ち）
  - メタキーワード
  - カノニカルURL
  - 構造化データ
  - 拡張用JSON
  - 記事編集時にプレビュー機能を提供
    - 編集内容を新しいウィンドウまたはタブで実際の公開イメージとして確認できる
    - プレビューは下書き状態でも利用可能
- カテゴリー管理  
  - カテゴリーの作成・編集・削除  
  - カテゴリー名、親子関係（階層構造）  
  - カテゴリーURL（スラッグ）  
  - カテゴリー紹介文（OGP description用）  
  - カテゴリーOGP画像
  - メタキーワード
  - カノニカルURL
  - 構造化データ
  - 拡張用JSON
- コメント管理
  - コメント一覧・承認・削除・編集
  - スパム対策（承認制）
- エクスポート機能（CSV/JSON）
- メール通知管理

---

## 5. 技術スタック・その他

- Python, Flask, Jinja2, Bootstrap
- 画像処理：Pillow（トリミング・リサイズ）
- Markdown対応
- データベース：SQLiteまたは他RDBMS
- 認証：Flask-Login等
- 画像アップロード時の自動トリミング・リサイズ
- OGP情報の各ページでの動的出力（title, description, image, url）
- SNS・外部記事埋込はカード形式等で表示
- 記事本文はブロックの配列としてDBに保存（順序情報を保持）
- テンプレートやCSSはBootstrap等のフレームワークに依存しすぎない構成
- カスタムフィールド追加やプラグイン機能を将来的に拡張しやすいDB設計

---

## 6. 権限管理・ユーザ種別
- 管理者（Admin）
  - 全機能へのフルアクセス
  - 全ユーザ・全記事・全カテゴリ・サイト設定の管理が可能

- 投稿者（Author）
  - 自分が作成した記事の作成・編集・削除
  - 自身のユーザ情報のみ編集可能

---

## 7. ファイルアップロードの制限
- 画像アップロード時の最大ファイルサイズ（例：2MBまで）
- 許可拡張子：jpg, jpeg, png, gif
- 不正なファイル形式やサイズ超過時はエラー表示
- 保存先ディレクトリは /uploads/images/ など

---

## 8. SEO・OGP以外のメタ情報
- 各記事・各カテゴリに meta keywords を設定可能
- サイト全体・記事・カテゴリごとに canonical URL を自動生成
- 構造化データ（JSON-LD）を記事ページに出力（記事タイトル、著者、公開日など）

---

## 9. パフォーマンス・セキュリティ
- CSRF対策：全フォームにCSRFトークンを付与
- XSS対策：テンプレートで自動エスケープ、Markdownレンダリング時もサニタイズ
- パスワードリセット用トークンは有効期限（例：1時間）付きで発行
- 管理画面はログインユーザのみアクセス可能

---

## 10. 運用・バックアップ
- データベースの定期バックアップ手順をドキュメント化
- 画像アップロードディレクトリもバックアップ対象
- 管理画面からエクスポート（CSV/JSON）機能の追加も検討

---

## 11. 拡張性
- テンプレートやCSSはBootstrap等のフレームワークに依存しすぎない構成
- カスタムフィールド追加やプラグイン機能を将来的に拡張しやすいDB設計
- 記事・ユーザ・カテゴリに「拡張用JSON」カラムを用意しておく

---

## 12. 通知機能
- 記事公開時に管理者・投稿者へメール通知（ON/OFF設定可）
- パスワードリセットやユーザ登録時にも通知メール送信
- コメント投稿時にメール通知（ON/OFF設定可）

---

## 13. コメント機能
- 各記事にコメント投稿欄を設置（公開/非公開設定可）
- コメントは管理者が承認後に公開（スパム対策）
- コメント投稿時にメール通知（ON/OFF設定可）

---

## 14. テスト・デバッグ機能

### 自動テスト機能
- 基本機能テスト: `test_app.py`
- 2段階認証機能テスト: `test_2fa_features.py`
- 管理機能デバッグ: `debug_admin.py`
- 包括的2FA機能テスト: `complete_2fa_test.py`

### 手動テスト機能
- 詳細な手動テスト手順書: `MANUAL_TEST_STEPS.md`
- 各機能の段階的テスト方法を記載
- テスト結果の記録方法を明記

### テスト対象機能
- ユーザー認証（ログイン・ログアウト）
- 2段階認証（TOTP）の設定・認証
- 記事の作成・編集・削除
- カテゴリ管理
- 画像アップロード・トリミング
- 権限管理（管理者・投稿者）
- SEO・OGP出力機能

---

# 仕様確定後の進め方

---

## 1. 画面遷移図の作成

- 必要な画面（ページ）を洗い出し、どの画面からどこへ遷移できるかを図で整理する
- 画面の全体像や必要なページを可視化し、抜け漏れ防止や実装計画に役立てる

---

## 2. データベース設計

- 仕様書をもとに、必要なテーブル・カラム・リレーションを設計する
- 画面遷移図と合わせて、どの画面でどのデータが必要かも確認する

---

## 3. 仕様書への変数名・型の明記

- 仕様書に「この項目はDBのどのカラムか」「画面上の変数名は何か」などを追記する
- 実装時の迷いを減らし、設計と実装の齟齬を防ぐ

---

## 4. ユースケース図（必要に応じて）

- 複数人開発や要件の複雑化が予想される場合は、ユースケース図があると役立つ
- 今回の規模なら必須ではないが、「誰が・どの機能を・どのように使うか」を整理したい場合は作成をおすすめ

---

## 5. テスト・品質保証

- 自動テストスクリプトの実行による機能検証
- 手動テスト手順書に従った総合的な動作確認
- セキュリティ面（2FA、CSRF対策など）の検証
- パフォーマンステスト（画像処理、データベース操作）

---

## おすすめの進め方

1. 画面遷移図を作成し、全体像を可視化
2. データベース設計を行い、必要なデータ構造を明確化
3. 仕様書に変数名や型を追記し、実装時の参照用にする
4. 必要に応じてユースケース図を作成し、利用者視点での機能整理を行う
5. 自動テストと手動テストを組み合わせた品質保証を実施

---